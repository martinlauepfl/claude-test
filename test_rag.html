<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .loading {
            color: #666;
        }
        .success {
            color: #4CAF50;
        }
        .error {
            color: #f44336;
        }
        .info {
            color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RAG功能测试</h1>

        <div class="test-section">
            <h3>1. 测试RAG搜索功能</h3>
            <p>输入问题，测试是否能从知识库中检索到相关内容</p>
            <input type="text" id="ragQuery" class="test-input" placeholder="例如：梦见蛇代表什么？" value="梦见蛇代表什么？">
            <button onclick="testRAGSearch()">测试RAG搜索</button>
            <div id="ragResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. 测试完整RAG对话</h3>
            <p>测试带RAG的AI对话功能</p>
            <input type="text" id="chatQuery" class="test-input" placeholder="例如：我的手相显示事业线很长，是什么意思？" value="我的手相显示事业线很长，是什么意思？">
            <button onclick="testRAGChat()">测试RAG对话</button>
            <div id="chatResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. 知识库统计</h3>
            <button onclick="showStats()">显示知识库统计</button>
            <div id="statsResult" class="result"></div>
        </div>
    </div>

    <script type="module">
        // 配置
        const SUPABASE_URL = 'https://mulrkyqqhaustbojzzes.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11bHJreXFxaGF1c3Rib2p6emVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NTAzNDYsImV4cCI6MjA3NjMyNjM0Nn0.zYo6hPjTd3i4h9P0XsE2nB7H9N-5k7w3L8P5a2bG8Xk';

        window.testRAGSearch = async function() {
            const queryInput = document.getElementById('ragQuery');
            const resultDiv = document.getElementById('ragResult');
            const query = queryInput.value.trim();

            if (!query) {
                resultDiv.innerHTML = '<span class="error">请输入查询内容</span>';
                return;
            }

            resultDiv.innerHTML = '<span class="loading">正在搜索...</span>';

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/rag-search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        query: query,
                        limit: 5,
                        threshold: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                resultDiv.innerHTML = `<span class="success">搜索成功！</span>\n\n` +
                    `检测到的分类: ${data.detected_category || '未分类'}\n` +
                    `找到 ${data.results?.length || 0} 个相关结果:\n\n` +
                    JSON.stringify(data, null, 2);

            } catch (error) {
                resultDiv.innerHTML = `<span class="error">搜索失败: ${error.message}</span>`;
            }
        };

        window.testRAGChat = async function() {
            const queryInput = document.getElementById('chatQuery');
            const resultDiv = document.getElementById('chatResult');
            const query = queryInput.value.trim();

            if (!query) {
                resultDiv.innerHTML = '<span class="error">请输入问题</span>';
                return;
            }

            resultDiv.innerHTML = '<span class="loading">正在获取回复...</span>';

            try {
                const messages = [
                    {
                        role: 'system',
                        content: '你是一个专业的算命大师，精通解梦、手相、风水、易经等传统文化。'
                    },
                    {
                        role: 'user',
                        content: query
                    }
                ];

                const response = await fetch(`${SUPABASE_URL}/functions/v1/ai-chat-with-rag`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        messages: messages
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // 处理流式响应
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                resultDiv.innerHTML = '<span class="info">AI回复（流式）:</span>\n\n';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.choices?.[0]?.delta?.content) {
                                    const content = parsed.choices[0].delta.content;
                                    fullResponse += content;
                                    resultDiv.textContent = fullResponse;
                                    resultDiv.scrollTop = resultDiv.scrollHeight;
                                }
                            } catch (e) {
                                // 忽略解析错误
                            }
                        }
                    }
                }

            } catch (error) {
                resultDiv.innerHTML = `<span class="error">对话失败: ${error.message}</span>`;
            }
        };

        window.showStats = async function() {
            const resultDiv = document.getElementById('statsResult');
            resultDiv.innerHTML = '<span class="loading">正在获取统计...</span>';

            try {
                // 这里需要service role key才能查询
                const response = await fetch(`${SUPABASE_URL}/rest/v1/knowledge_base?select=category,source`, {
                    method: 'GET',
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11bHJreXFxaGF1c3Rib2p6emVzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDc1MDM0NiwiZXhwIjoyMDc2MzI2MzQ2fQ.Tq-69aOZrxCU2IvhqzSFyIn_dCAIN9iRR3PwYZHDvVA'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // 统计分类和来源
                const categories = {};
                const sources = {};

                data.forEach(item => {
                    categories[item.category] = (categories[item.category] || 0) + 1;
                    sources[item.source] = (sources[item.source] || 0) + 1;
                });

                resultDiv.innerHTML = `<span class="success">知识库统计</span>\n\n` +
                    `总记录数: ${data.length}\n\n` +
                    `分类统计:\n${Object.entries(categories).map(([k, v]) => `  ${k}: ${v}条`).join('\n')}\n\n` +
                    `书籍统计:\n${Object.entries(sources).map(([k, v]) => `  ${k}: ${v}条`).join('\n')}`;

            } catch (error) {
                resultDiv.innerHTML = `<span class="error">获取统计失败: ${error.message}</span>`;
            }
        };
    </script>
</body>
</html>