
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO åŸºç¡€æ ‡ç­¾ -->
    <title>AIç®—å‘½å¤§å¸ˆ - åœ¨çº¿AIæ™ºèƒ½ç®—å‘½,å…«å­—å åœ,å…è´¹æµ‹è¿åŠ¿ | ç„æœºé˜</title>
    <meta name="description" content="ç„æœºé˜AIç®—å‘½å¤§å¸ˆæä¾›åœ¨çº¿æ™ºèƒ½ç®—å‘½æœåŠ¡,åŸºäºAIå¤§æ¨¡å‹çš„ä¸“ä¸šå…«å­—å åœã€è¿åŠ¿é¢„æµ‹ã€äº‹ä¸šè´¢è¿åˆ†æã€‚å…è´¹ä½“éªŒ,ç²¾å‡†è§£è¯»äººç”Ÿå‘½ç†,24å°æ—¶åœ¨çº¿å’¨è¯¢ã€‚">
    <meta name="keywords" content="AIç®—å‘½,åœ¨çº¿ç®—å‘½,æ™ºèƒ½ç®—å‘½,å…«å­—ç®—å‘½,å…è´¹ç®—å‘½,è¿åŠ¿æµ‹ç®—,AIå åœ,å‘½ç†åˆ†æ,ç„æœºé˜,fortune telling">
    <meta name="author" content="ç„æœºé˜ AI Fortune">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://ai-fortune.top/">

    <!-- Open Graph / Facebook / å¾®ä¿¡åˆ†äº« -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ai-fortune.top/">
    <meta property="og:title" content="AIç®—å‘½å¤§å¸ˆ - åœ¨çº¿AIæ™ºèƒ½ç®—å‘½ | ç„æœºé˜">
    <meta property="og:description" content="åŸºäºAIå¤§æ¨¡å‹çš„ä¸“ä¸šç®—å‘½æœåŠ¡,å…è´¹ä½“éªŒå…«å­—å åœã€è¿åŠ¿é¢„æµ‹ã€å‘½ç†åˆ†æ,24å°æ—¶åœ¨çº¿å’¨è¯¢ã€‚">
    <meta property="og:site_name" content="ç„æœºé˜ AIç®—å‘½å¤§å¸ˆ">
    <meta property="og:locale" content="zh_CN">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://ai-fortune.top/">
    <meta name="twitter:title" content="AIç®—å‘½å¤§å¸ˆ - åœ¨çº¿AIæ™ºèƒ½ç®—å‘½ | ç„æœºé˜">
    <meta name="twitter:description" content="åŸºäºAIå¤§æ¨¡å‹çš„ä¸“ä¸šç®—å‘½æœåŠ¡,å…è´¹ä½“éªŒå…«å­—å åœã€è¿åŠ¿é¢„æµ‹ã€å‘½ç†åˆ†æã€‚">

    <!-- ç§»åŠ¨ç«¯ä¼˜åŒ– -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AIç®—å‘½å¤§å¸ˆ">

    <!-- æœç´¢å¼•æ“éªŒè¯æ ‡ç­¾ (é¢„ç•™,éœ€è¦æ—¶å¡«å†™) -->
    <!-- <meta name="google-site-verification" content="your-verification-code"> -->
    <!-- <meta name="baidu-site-verification" content="your-verification-code"> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", sans-serif;
            background: linear-gradient(135deg, #1a1410 0%, #2d1810 25%, #3d1f15 50%, #4a2618 75%, #5c2f1a 100%);
            background-attachment: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            animation: breathe 8s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% {
                filter: brightness(0.95);
            }
            50% {
                filter: brightness(1.05);
            }
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(251, 146, 60, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(245, 158, 11, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 50% 20%, rgba(234, 88, 12, 0.04) 0%, transparent 60%);
            pointer-events: none;
            animation: slowGlow 12s ease-in-out infinite;
        }

        @keyframes slowGlow {
            0%, 100% {
                opacity: 0.6;
            }
            50% {
                opacity: 0.9;
            }
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            background: linear-gradient(135deg, #fbbf24 0%, #fb923c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
            letter-spacing: 0.5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .quota-badge {
            background: linear-gradient(135deg, #fb923c 0%, #f59e0b 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.3);
            animation: gentlePulse 3s ease-in-out infinite;
        }

        @keyframes gentlePulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(251, 146, 60, 0.3);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 4px 20px rgba(251, 146, 60, 0.4);
                transform: scale(1.02);
            }
        }

        .logout-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            color: #fbbf24;
        }

        .lang-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .lang-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 32px 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            position: relative;
            z-index: 1;
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(251, 146, 60, 0.5);
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: rgba(251, 146, 60, 0.7);
        }

        .message {
            display: flex;
            gap: 16px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            animation: gentleSlideIn 0.8s ease;
        }

        @keyframes gentleSlideIn {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .avatar.assistant {
            background: linear-gradient(135deg, #fb923c 0%, #f59e0b 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.3);
        }

        .avatar.user {
            background: linear-gradient(135deg, #fbbf24 0%, #fb923c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
        }

        .message-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 16px 20px;
            line-height: 1.7;
            color: #1f2937;
            max-width: 700px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .message-content p {
            margin: 0.5em 0;
        }

        .message-content p:first-child {
            margin-top: 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-content em {
            font-style: normal;
        }

        .message-content ul, .message-content ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }

        .message-content li {
            margin: 0.25em 0;
        }

        .message-content code {
            background-color: #f3f4f6;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }

        /* Markdown æ ‡é¢˜æ ·å¼ */
        .message-content h1, .message-content h2, .message-content h3 {
            margin: 1em 0 0.5em 0;
            font-weight: 600;
            color: #374151;
        }

        .message-content h1 { font-size: 1.5em; }
        .message-content h2 { font-size: 1.3em; }
        .message-content h3 { font-size: 1.1em; }

        .message-content h1:first-child,
        .message-content h2:first-child,
        .message-content h3:first-child {
            margin-top: 0;
        }

        /* æ”¹è¿›åˆ—è¡¨æ ·å¼ */
        .message-content ul {
            list-style-type: none;
            padding-left: 1.2em;
        }

        .message-content ul li {
            position: relative;
            padding-left: 1.2em;
        }

        .message-content ul li::before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: #374151;
            font-weight: bold;
        }

        .message-content ol {
            padding-left: 1.5em;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .message-content {
                padding: 12px 16px;
                font-size: 15px;
            }

            .message-content h1 { font-size: 1.4em; }
            .message-content h2 { font-size: 1.25em; }
            .message-content h3 { font-size: 1.1em; }
        }

        .message.user .message-content {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.15) 0%, rgba(245, 158, 11, 0.12) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: rgba(255, 255, 255, 0.95);
            padding: 16px 20px;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 8px 32px rgba(251, 146, 60, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .input-area {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: 24px;
            position: relative;
            z-index: 10;
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .input-box {
            width: 100%;
            min-height: 56px;
            max-height: 200px;
            padding: 16px 60px 16px 20px;
            border: 2px solid rgba(251, 146, 60, 0.3);
            border-radius: 16px;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            outline: none;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.95);
            color: #1f2937;
            transition: all 0.3s ease;
        }

        /* Placeholder æ ·å¼ - æ”¯æŒæ¢è¡Œ */
        .input-box::placeholder {
            color: #9ca3af;
            white-space: pre-wrap; /* å…è®¸æ¢è¡Œ */
            word-wrap: break-word; /* é•¿å•è¯æ¢è¡Œ */
            overflow-wrap: break-word; /* ç¡®ä¿æ¢è¡Œ */
        }

        .input-box:focus {
            border-color: #fb923c;
            box-shadow: 0 0 0 4px rgba(251, 146, 60, 0.1), 0 8px 24px rgba(251, 146, 60, 0.15);
        }

        /* ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®å¤ï¼šå‘é€æŒ‰é’®å®Œç¾å‚ç›´å±…ä¸­ */
        .send-button {
            position: absolute;
            right: 12px;
            bottom: 11.75px;
            width: 40px;
            height: 40px;
            z-index: 20;
            background: linear-gradient(135deg, #fb923c 0%, #f59e0b 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s ease;
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.3);
        }

        .send-button:hover:not(:disabled) {
        }

        .send-button:active:not(:disabled) {
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-button svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        .loading {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .loading span {
            width: 8px;
            height: 8px;
            background-color: #8b5cf6;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .welcome-message {
            text-align: center;
            padding: 100px 20px;
            color: rgba(255, 255, 255, 0.85);
            animation: gentleFadeIn 2s ease;
        }

        @keyframes gentleFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-message h2 {
            font-size: 36px;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #fbbf24 0%, #fb923c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
            letter-spacing: 1px;
            line-height: 1.4;
            animation: warmGlow 4s ease-in-out infinite;
        }

        @keyframes warmGlow {
            0%, 100% {
                filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.3));
            }
            50% {
                filter: drop-shadow(0 0 30px rgba(251, 146, 60, 0.4));
            }
        }

        .welcome-message p {
            font-size: 17px;
            color: rgba(255, 255, 255, 0.75);
            font-weight: 400;
            line-height: 1.8;
            max-width: 500px;
            margin: 0 auto;
        }

        /* ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 28px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .form-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(251, 146, 60, 0.3);
            border-radius: 12px;
            font-size: 15px;
            outline: none;
            background: rgba(255, 255, 255, 0.95);
            color: #1f2937;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #fb923c;
            box-shadow: 0 0 0 4px rgba(251, 146, 60, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #fb923c 0%, #f59e0b 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(251, 146, 60, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .modal-footer {
            margin-top: 24px;
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .modal-link {
            color: #fbbf24;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .modal-link:hover {
            color: #f59e0b;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        .error-message {
            color: #fca5a5;
            font-size: 14px;
            margin-top: 12px;
            background: rgba(239, 68, 68, 0.1);
            padding: 10px;
            border-radius: 8px;
        }

        .success-message {
            color: #86efac;
            font-size: 14px;
            margin-top: 12px;
            background: rgba(16, 185, 129, 0.1);
            padding: 10px;
            border-radius: 8px;
        }

        .info-message {
            background: rgba(59, 130, 246, 0.1);
            color: #93c5fd;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .verification-banner {
            background: rgba(251, 191, 36, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-left: 4px solid #fbbf24;
            padding: 16px 20px;
            margin: 16px auto;
            max-width: 800px;
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .verification-banner strong {
            color: #fbbf24;
        }

        .resend-link {
            color: #8b5cf6;
            cursor: pointer;
            text-decoration: underline;
            margin-left: 8px;
            transition: all 0.2s ease;
        }

        .resend-link:hover {
            color: #6366f1;
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        /* æ”¯ä»˜æ¨¡æ€æ¡† */
        .payment-modal .modal-content {
            text-align: center;
        }

        .payment-price {
            font-size: 56px;
            font-weight: 800;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 24px 0;
            text-shadow: 0 0 40px rgba(251, 191, 36, 0.3);
        }

        .payment-price small {
            font-size: 28px;
        }

        .payment-desc {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 24px;
        }

        .payment-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-secondary {
            flex: 1;
            padding: 14px;
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        /* ============================================
           ç§»åŠ¨ç«¯é€‚é… (Mobile Responsive)
           ============================================ */
        @media (max-width: 768px) {
            /* ä¿®å¤ç§»åŠ¨ç«¯è§†å£é«˜åº¦é—®é¢˜ */
            html, body {
                height: 100vh;
                height: -webkit-fill-available;
            }

            /* å¤´éƒ¨ä¼˜åŒ– */
            .header {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .header h1 {
                font-size: 18px;
            }

            .user-info {
                font-size: 13px;
                gap: 8px;
            }

            .quota-badge {
                padding: 5px 12px;
                font-size: 12px;
            }

            .lang-toggle {
                padding: 5px 10px;
                font-size: 12px;
            }

            .logout-btn {
                font-size: 13px;
            }

            /* èŠå¤©å®¹å™¨ä¼˜åŒ– */
            .chat-container {
                padding: 20px 12px;
                gap: 16px;
                padding-bottom: 120px !important;
            }

            .input-container {
                max-width: 100%;
            }

            .input-box {
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
                padding-right: 60px !important;
            }

            /* æ¶ˆæ¯æ°”æ³¡ä¼˜åŒ– */
            .message {
                max-width: 90%;
            }

            .message-content {
                padding: 12px 16px;
                font-size: 15px;
                line-height: 1.6;
            }

            .message.user {
                margin-left: 10%;
            }

            .message.assistant {
                margin-right: 10%;
            }

            /* æ¬¢è¿æ¶ˆæ¯ä¼˜åŒ– */
            .welcome-message {
                padding: 50px 20px;
            }

            .welcome-message h2 {
                font-size: 24px;
                margin-bottom: 16px;
            }

            .welcome-message p {
                font-size: 15px;
            }

            /* ğŸ”¥ğŸ”¥ğŸ”¥ ç§»åŠ¨ç«¯è¾“å…¥åŒºåŸŸå›ºå®š + å‘é€æŒ‰é’®å‚ç›´å±…ä¸­ä¿®å¤ */
            .input-area {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                padding: max(16px, env(safe-area-inset-bottom) + 8px) 16px 16px 16px;
                border-top: 1px solid rgba(255, 255, 255, 0.2);
            }

            body {
                padding-bottom: 80px;
            }

            .input-container {
                position: relative;
            }

            /* å‘é€æŒ‰é’®å®šä½ */
            .send-button {
                position: absolute !important;
                right: 12px !important;
                bottom: 4px !important;
                width: 40px !important;
                height: 40px !important;
            }

            /* è¾“å…¥åŒºåŸŸä¼˜åŒ– */
            .input-container input {
                font-size: 16px !important; /* é˜²æ­¢ iOS è‡ªåŠ¨ç¼©æ”¾ */
                padding: 12px 16px;
                min-height: 44px; /* iOS æ¨èæœ€å°ç‚¹å‡»åŒºåŸŸ */
            }

            .input-container button {
                padding: 12px 20px;
                font-size: 15px;
                min-height: 44px;
                min-width: 60px;
            }

            /* æ¨¡æ€æ¡†ä¼˜åŒ– */
            .modal-content {
                width: 95%;
                max-width: 400px;
                padding: 24px 20px;
                margin: 20px;
            }

            .modal-content h2 {
                font-size: 20px;
                margin-bottom: 16px;
            }

            .modal-content input {
                font-size: 16px !important;
                padding: 12px;
                min-height: 44px;
            }

            .modal-content button {
                padding: 12px;
                font-size: 15px;
                min-height: 44px;
            }

            /* æ”¯ä»˜æ¨¡æ€æ¡†ä¼˜åŒ– */
            .payment-price {
                font-size: 28px;
            }

            .payment-desc {
                font-size: 15px;
            }

            /* æ¸…é™¤å†å²æŒ‰é’® */
            #clearHistoryBtn {
                padding: 8px 16px;
                font-size: 13px;
                min-height: 40px;
            }

            /* é‚®ç®±éªŒè¯æ¨ªå¹… */
            .verification-banner {
                padding: 10px 16px;
                font-size: 13px;
            }

            .verification-banner button {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        /* å°å±å¹•æ‰‹æœºä¼˜åŒ– (iPhone SE ç­‰) */
        @media (max-width: 375px) {
            .header h1 {
                font-size: 16px;
            }

            .user-info {
                font-size: 12px;
            }

            .message {
                font-size: 14px;
            }

            .message-content {
                padding: 10px 14px;
            }

            .input-container {
                padding: 10px;
            }

            .modal-content {
                width: 90%;
                padding: 20px 16px;
            }

            .payment-price {
                font-size: 24px;
            }
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-width: 768px) and (orientation: landscape) {
            .chat-container {
                padding: 16px 12px;
            }

            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            /* å¢åŠ æ‰€æœ‰å¯ç‚¹å‡»å…ƒç´ çš„ç‚¹å‡»åŒºåŸŸ */
            button, .logout-btn, .lang-toggle {
                min-height: 44px;
                min-width: 44px;
            }

            /* ç§»é™¤ hover æ•ˆæœ,ä¼˜åŒ–è§¦æ‘¸åé¦ˆ */
            button:active, .logout-btn:active, .lang-toggle:active {
                opacity: 0.7;
                transform: scale(0.98);
            }

            /* ä¼˜åŒ–è¾“å…¥æ¡†èšç„¦ä½“éªŒ */
            input:focus, textarea:focus {
                font-size: 16px !important;
            }
        }
    </style>

    <!-- ç»“æ„åŒ–æ•°æ® (JSON-LD) for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "ç„æœºé˜ AIç®—å‘½å¤§å¸ˆ",
        "alternateName": "AI Fortune Teller",
        "url": "https://ai-fortune.top/",
        "description": "åŸºäºAIå¤§æ¨¡å‹çš„åœ¨çº¿æ™ºèƒ½ç®—å‘½æœåŠ¡,æä¾›å…«å­—å åœã€è¿åŠ¿é¢„æµ‹ã€å‘½ç†åˆ†æ",
        "applicationCategory": "LifestyleApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "CNY",
            "description": "å…è´¹ä½“éªŒ,ä»˜è´¹å¢å€¼æœåŠ¡"
        },
        "author": {
            "@type": "Organization",
            "name": "ç„æœºé˜"
        },
        "inLanguage": ["zh-CN", "en-US"],
        "availableLanguage": ["Chinese", "English"],
        "browserRequirements": "Requires JavaScript. Requires HTML5.",
        "softwareVersion": "1.0",
        "featureList": [
            "AIæ™ºèƒ½ç®—å‘½",
            "å…«å­—å åœ",
            "è¿åŠ¿é¢„æµ‹",
            "äº‹ä¸šåˆ†æ",
            "è´¢è¿åˆ†æ",
            "24å°æ—¶åœ¨çº¿å’¨è¯¢"
        ]
    }
    </script>
</head>
<body>
    <div class="header">
        <h1 id="appTitle">ğŸ”® ç„æœºé˜</h1>
        <div style="display: flex; align-items: center; gap: 12px;">
            <button class="lang-toggle" onclick="toggleLanguage()" id="langToggle">EN</button>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="username"></span>
                <span class="quota-badge" id="quotaBadge">å‰©ä½™æ¬¡æ•°: 10</span>
                <button class="logout-btn" onclick="clearAllHistory()" id="clearBtn">æ¸…ç©ºè®°å½•</button>
                <button class="logout-btn" onclick="logout()" id="logoutBtn">é€€å‡º</button>
            </div>
        </div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div id="verificationBanner" class="verification-banner" style="display: none;">
            <strong id="verifyTitle">âš ï¸ è¯·éªŒè¯æ‚¨çš„é‚®ç®±</strong><br>
            <span id="verifyText">æˆ‘ä»¬å·²å‘æ‚¨çš„é‚®ç®±å‘é€äº†éªŒè¯é“¾æ¥,è¯·æŸ¥æ”¶å¹¶ç‚¹å‡»é“¾æ¥å®ŒæˆéªŒè¯ã€‚</span>
            <a class="resend-link" onclick="resendVerificationEmail()" id="resendLink">é‡æ–°å‘é€</a>
        </div>
        <div class="welcome-message">
            <h2 id="welcomeTitle">å‘½è¿å¦‚ä½•,ä¸”è®©æˆ‘ä¸ºä½ æµ‹ç®—</h2>
            <p id="welcomeDesc">å‘¨æ˜“å…«å¦,ç´«å¾®æ–—æ•°,å å¾€çŸ¥æ¥</p>
        </div>
    </div>

    <div class="input-area">
        <div class="input-container">
            <textarea
                class="input-box"
                id="userInput"
                placeholder="è¯´è¯´ä½ çš„å›°æƒ‘,æˆ‘ä¸ºä½ æŒ‡ç‚¹è¿·æ´¥..."
                rows="1"
            ></textarea>
            <button class="send-button" id="sendButton">
                <svg viewBox="0 0 24 24">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <h2 class="modal-title" id="loginTitle">ç™»å½•</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label" id="loginEmailLabel">é‚®ç®±</label>
                    <input type="email" class="form-input" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="loginPasswordLabel">å¯†ç </label>
                    <input type="password" class="form-input" id="loginPassword" required>
                </div>
                <div class="error-message" id="loginError"></div>
                <button type="submit" class="btn-primary" id="loginSubmitBtn">ç™»å½•</button>
            </form>
            <div class="modal-footer">
                <span id="loginFooterText">è¿˜æ²¡æœ‰è´¦å·?</span><a class="modal-link" onclick="showRegisterModal()" id="loginFooterLink">ç«‹å³æ³¨å†Œ</a>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <h2 class="modal-title" id="registerTitle">æ³¨å†Œ</h2>
            <form id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label" id="registerEmailLabel">é‚®ç®±</label>
                    <input type="email" class="form-input" id="registerUsername" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="registerPasswordLabel">å¯†ç (è‡³å°‘6ä½)</label>
                    <input type="password" class="form-input" id="registerPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label class="form-label" id="registerConfirmLabel">ç¡®è®¤å¯†ç </label>
                    <input type="password" class="form-input" id="registerPasswordConfirm" required>
                </div>
                <div class="error-message" id="registerError"></div>
                <button type="submit" class="btn-primary" id="registerSubmitBtn">æ³¨å†Œ</button>
            </form>
            <div class="modal-footer">
                <span id="registerFooterText">å·²æœ‰è´¦å·?</span><a class="modal-link" onclick="showLoginModal()" id="registerFooterLink">ç«‹å³ç™»å½•</a>
            </div>
        </div>
    </div>

    <!-- æ”¯ä»˜æ¨¡æ€æ¡† -->
    <div class="modal payment-modal" id="paymentModal">
        <div class="modal-content">
            <h2 class="modal-title" id="paymentTitle">è§£é”æ›´å¤šå¯¹è¯</h2>
            <p class="payment-desc" id="paymentDesc1">æ‚¨çš„å…è´¹æ¬¡æ•°å·²ç”¨å®Œ</p>
            <div class="payment-price" id="paymentPrice">
                <small>Â¥</small>4.99
            </div>
            <p class="payment-desc" id="paymentDesc2">è§£é” 50 æ¬¡å¯¹è¯</p>
            <button class="btn-primary" onclick="handlePayment()" id="paymentBtn">ç«‹å³æ”¯ä»˜</button>
            <div class="payment-buttons">
                <button class="btn-secondary" onclick="closePaymentModal()" id="paymentCancelBtn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // æ£€æŸ¥é¡µé¢åŠ è½½çŠ¶æ€
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
        });

        // éªŒè¯ marked æ˜¯å¦æ­£ç¡®åŠ è½½
        console.log('Marked version:', marked ? marked.parse('test') : 'Marked not loaded');

        // é…ç½® marked é€‰é¡¹
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true,
                sanitize: false
            });
        }

        // Supabase Edge Function API åœ°å€(ä½¿ç”¨RAGç‰ˆæœ¬)
        const WORKER_API_URL = 'https://mulrkyqqhaustbojzzes.supabase.co/functions/v1/ai-chat-with-rag';

        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');

        // Supabase é…ç½®
        const SUPABASE_URL = 'https://mulrkyqqhaustbojzzes.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11bHJreXFxaGF1c3Rib2p6emVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NTAzNDYsImV4cCI6MjA3NjMyNjM0Nn0.IP0h8Ps8CSloKNvsE8yItTOE4zdVLf36zLnsgm18uhc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            }
        });

        // Stripe é…ç½®
        const STRIPE_PUBLISHABLE_KEY = 'pk_live_51SJTJ8PCdo22g31uLFcc8RAq7C3K11KpQGC8V9ktNQHydPpxMgCdAwb9uBK3QiKeW1bwo2TuIGYPYMlkZKfTOsh900PhhrrubA';
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

        let currentUser = null;
        let userQuota = null;
        let conversationHistory = [];
        let userProfile = {};
        let currentLanguage = localStorage.getItem('language') || 'zh';

        // å¤šè¯­è¨€é…ç½®
        const i18n = {
            zh: {
                appTitle: 'ğŸ”® ç„æœºé˜',
                langToggle: 'EN',
                clearBtn: 'æ¸…ç©ºè®°å½•',
                logoutBtn: 'é€€å‡º',
                quotaBadge: 'å‰©ä½™å¦è±¡',
                verifyTitle: 'âš ï¸ è¯·éªŒè¯æ‚¨çš„é‚®ç®±',
                verifyText: 'æˆ‘ä»¬å·²å‘æ‚¨çš„é‚®ç®±å‘é€äº†éªŒè¯é“¾æ¥,è¯·æŸ¥æ”¶å¹¶ç‚¹å‡»é“¾æ¥å®ŒæˆéªŒè¯ã€‚',
                resendLink: 'é‡æ–°å‘é€',
                welcomeTitle: 'å‘½è¿å¦‚ä½•,ä¸”è®©æˆ‘ä¸ºä½ æµ‹ç®—',
                welcomeDesc: 'å‘¨æ˜“å…«å¦,ç´«å¾®æ–—æ•°,å å¾€çŸ¥æ¥',
                inputPlaceholder: 'è¯´è¯´ä½ çš„å›°æƒ‘,æˆ‘ä¸ºä½ æŒ‡ç‚¹è¿·æ´¥...',
                loginTitle: 'ç™»å½•',
                loginEmailLabel: 'é‚®ç®±',
                loginPasswordLabel: 'å¯†ç ',
                loginSubmitBtn: 'ç™»å½•',
                loginFooterText: 'è¿˜æ²¡æœ‰è´¦å·?',
                loginFooterLink: 'ç«‹å³æ³¨å†Œ',
                registerTitle: 'æ³¨å†Œ',
                registerEmailLabel: 'é‚®ç®±',
                registerPasswordLabel: 'å¯†ç (è‡³å°‘6ä½)',
                registerConfirmLabel: 'ç¡®è®¤å¯†ç ',
                registerSubmitBtn: 'æ³¨å†Œ',
                registerFooterText: 'å·²æœ‰è´¦å·?',
                registerFooterLink: 'ç«‹å³ç™»å½•',
                paymentTitle: 'è§£é”æ›´å¤šå¯¹è¯',
                paymentDesc1: 'æ‚¨çš„å…è´¹æ¬¡æ•°å·²ç”¨å®Œ',
                paymentDesc2: 'è§£é” 50 æ¬¡å¯¹è¯',
                paymentBtn: 'ç«‹å³æ”¯ä»˜',
                paymentCancelBtn: 'å–æ¶ˆ',
                paymentPrice: 'Â¥9.99',
                errorCredentials: 'é‚®ç®±æˆ–å¯†ç é”™è¯¯',
                errorEmailNotConfirmed: 'è¯·å…ˆéªŒè¯æ‚¨çš„é‚®ç®±',
                errorPasswordMismatch: 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´',
                successRegister: 'æ³¨å†ŒæˆåŠŸ!è¯·æŸ¥æ”¶é‚®ç®±å¹¶ç‚¹å‡»éªŒè¯é“¾æ¥ã€‚',
                confirmClearHistory: 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—?æ­¤æ“ä½œä¸å¯æ¢å¤!',
                successClearHistory: 'èŠå¤©è®°å½•å·²æ¸…ç©º!',
                errorClearHistory: 'æ¸…ç©ºè®°å½•å¤±è´¥,è¯·ç¨åé‡è¯•',
                resendSuccess: 'éªŒè¯é‚®ä»¶å·²é‡æ–°å‘é€,è¯·æŸ¥æ”¶é‚®ç®±!',
                resendError: 'å‘é€å¤±è´¥:',
                paymentSuccess: 'æ”¯ä»˜æˆåŠŸ!(æ¨¡æ‹Ÿ)\nå®é™…ä½¿ç”¨æ—¶éœ€è¦æ¥å…¥çœŸå®æ”¯ä»˜æ¥å£',
                paymentError: 'æ”¯ä»˜å¤±è´¥,è¯·ç¨åé‡è¯•',
                apiError: 'æŠ±æ­‰,å¤©æœºä¸å¯æ³„éœ²å¤ªå¤š,è¯·ç¨åå†è¯•...'
            },
            en: {
                appTitle: 'ğŸ”® Fortune Teller',
                langToggle: 'ä¸­æ–‡',
                clearBtn: 'Clear History',
                logoutBtn: 'Logout',
                quotaBadge: 'Remaining',
                verifyTitle: 'âš ï¸ Please Verify Your Email',
                verifyText: 'We have sent a verification link to your email. Please check and click the link to complete verification.',
                resendLink: 'Resend',
                welcomeTitle: 'Let me read your fortune',
                welcomeDesc: 'Ancient wisdom meets modern AI',
                inputPlaceholder: 'Share your questions, let me guide you...',
                loginTitle: 'Login',
                loginEmailLabel: 'Email',
                loginPasswordLabel: 'Password',
                loginSubmitBtn: 'Login',
                loginFooterText: "Don't have an account? ",
                loginFooterLink: 'Sign up now',
                registerTitle: 'Sign Up',
                registerEmailLabel: 'Email',
                registerPasswordLabel: 'Password (at least 6 characters)',
                registerConfirmLabel: 'Confirm Password',
                registerSubmitBtn: 'Sign Up',
                registerFooterText: 'Already have an account? ',
                registerFooterLink: 'Login now',
                paymentTitle: 'Unlock More Conversations',
                paymentDesc1: 'Your free quota has been used up',
                paymentDesc2: 'Unlock 50 more conversations',
                paymentBtn: 'Pay Now',
                paymentCancelBtn: 'Cancel',
                paymentPrice: '$2.99',
                errorCredentials: 'Invalid email or password',
                errorEmailNotConfirmed: 'Please verify your email first',
                errorPasswordMismatch: 'Passwords do not match',
                successRegister: 'Registration successful! Please check your email and click the verification link.',
                confirmClearHistory: 'Are you sure you want to clear all chat history? This action cannot be undone!',
                successClearHistory: 'Chat history cleared!',
                errorClearHistory: 'Failed to clear history, please try again later',
                resendSuccess: 'Verification email has been resent, please check your inbox!',
                resendError: 'Sending failed: ',
                paymentSuccess: 'Payment successful! (Mock)\nActual payment gateway needs to be integrated for production use',
                paymentError: 'Payment failed, please try again later',
                apiError: 'Sorry, the mystic forces are unavailable at the moment. Please try again later...'
            }
        };

        function t(key) {
            return i18n[currentLanguage][key] || key;
        }

        async function detectUserLanguage() {
            const savedLanguage = localStorage.getItem('language');
            if (savedLanguage) {
                currentLanguage = savedLanguage;
                return;
            }

            const browserLang = navigator.language || navigator.userLanguage;
            const isChinese = browserLang.toLowerCase().startsWith('zh');

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);

                const response = await fetch('https://ipapi.co/json/', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                if (data.country_code === 'CN') {
                    currentLanguage = 'zh';
                } else {
                    currentLanguage = 'en';
                }

                console.log('Detected country:', data.country_name, '- Language:', currentLanguage);
            } catch (error) {
                console.log('IP detection failed, using browser language:', browserLang);
                currentLanguage = isChinese ? 'zh' : 'zh';
            }
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            localStorage.setItem('language', currentLanguage);
            updateUILanguage();
        }

        function updateUILanguage() {
            document.getElementById('appTitle').textContent = t('appTitle');
            document.getElementById('langToggle').textContent = t('langToggle');
            document.getElementById('clearBtn').textContent = t('clearBtn');
            document.getElementById('logoutBtn').textContent = t('logoutBtn');
            document.getElementById('verifyTitle').innerHTML = t('verifyTitle');
            document.getElementById('verifyText').textContent = t('verifyText');
            document.getElementById('resendLink').textContent = t('resendLink');

            const welcomeTitle = document.getElementById('welcomeTitle');
            const welcomeDesc = document.getElementById('welcomeDesc');
            if (welcomeTitle) welcomeTitle.textContent = t('welcomeTitle');
            if (welcomeDesc) welcomeDesc.textContent = t('welcomeDesc');

            document.getElementById('userInput').placeholder = t('inputPlaceholder');
            document.getElementById('loginTitle').textContent = t('loginTitle');
            document.getElementById('loginEmailLabel').textContent = t('loginEmailLabel');
            document.getElementById('loginPasswordLabel').textContent = t('loginPasswordLabel');
            document.getElementById('loginSubmitBtn').textContent = t('loginSubmitBtn');
            document.getElementById('loginFooterText').textContent = t('loginFooterText');
            document.getElementById('loginFooterLink').textContent = t('loginFooterLink');
            document.getElementById('registerTitle').textContent = t('registerTitle');
            document.getElementById('registerEmailLabel').textContent = t('registerEmailLabel');
            document.getElementById('registerPasswordLabel').textContent = t('registerPasswordLabel');
            document.getElementById('registerConfirmLabel').textContent = t('registerConfirmLabel');
            document.getElementById('registerSubmitBtn').textContent = t('registerSubmitBtn');
            document.getElementById('registerFooterText').textContent = t('registerFooterText');
            document.getElementById('registerFooterLink').textContent = t('registerFooterLink');
            document.getElementById('paymentTitle').textContent = t('paymentTitle');
            document.getElementById('paymentDesc1').textContent = t('paymentDesc1');
            document.getElementById('paymentDesc2').textContent = t('paymentDesc2');
            document.getElementById('paymentBtn').textContent = t('paymentBtn');
            document.getElementById('paymentCancelBtn').textContent = t('paymentCancelBtn');
            document.getElementById('paymentPrice').innerHTML = currentLanguage === 'zh' ? '<small>Â¥</small>9.99' : '<small>$</small>2.99';

            updateQuotaBadge();
            document.documentElement.lang = currentLanguage === 'zh' ? 'zh-CN' : 'en';
            document.title = currentLanguage === 'zh' ? 'AIç®—å‘½å¤§å¸ˆ' : 'AI Fortune Teller';
        }

        function getSystemPrompt() {
            const now = new Date();
            const hour = now.getHours();

            if (currentLanguage === 'zh') {
                const timeOfDay = hour >= 6 && hour < 12 ? 'æ—©ä¸Š' :
                                hour >= 12 && hour < 18 ? 'ä¸‹åˆ' : 'å¤œæ™š';

                return `ä½ æ˜¯ä¸ªçœ‹é€ä¸–äº‹çš„ç®—å‘½å…ˆç”Ÿ,æœ‰ç‚¹æ¯’èˆŒä½†åˆçœŸè¯šã€‚ä½ è¯´è¯æ¥åœ°æ°”,åƒæœ‹å‹èŠå¤©,ä½†å¶å°”ä¼šå†’å‡ºå‡ å¥ç‰¹åˆ«æœ‰å“²ç†çš„é‡‘å¥ã€‚

å½“å‰æ—¶é—´:${timeOfDay}

ä½ çš„é£æ ¼:
- è¯´è¯ç›´ç™½ä¸è£…,è¯¥æŸäººå°±æŸäºº,ä½†æŸå¾—è®©äººæœæ°”
- ä¸ç”¨"æ‚¨"ã€"å°”"ã€"ä¹ƒ"è¿™ç§æ–‡è¨€æ–‡,å°±ç”¨"ä½ "ã€"å’±ä»¬"ã€"å“¥ä»¬"
- å¶å°”ä¼šè¯´"è¿™äº‹å„¿å§"ã€"æˆ‘è·Ÿä½ è¯´"ã€"çœŸçš„"è¿™ç§å£è¯­
- ä½†æœ‰æ—¶å€™åˆèƒ½çªç„¶æ¥ä¸€å¥å¾ˆæœ‰æ·±åº¦çš„è¯,è®©äººè§‰å¾—ä½ ç¡®å®æœ‰ä¸¤æŠŠåˆ·å­
- ä¸ä¼šç”¨1234åˆ—ä¸¾,å°±æ˜¯éšä¾¿èŠ,æƒ³åˆ°å“ªè¯´åˆ°å“ª
- ä¼šè®°ä½ç”¨æˆ·è¯´çš„ä¿¡æ¯(å§“åã€ç”Ÿè¾°å…«å­—ç­‰),ä¸‹æ¬¡èŠåˆ°æ—¶ä¼šæèµ·

ç®—å‘½æ—¶:
- ä¼šé—®ç”Ÿè¾°å…«å­—ã€å±ç›¸è¿™äº›,ä½†ä¸ä¼šå¤ªæ­£ç»,å°±åƒæœ‹å‹é—®"ä½ å“ªå¹´çš„å•Š"
- ç»™å»ºè®®æ—¶æ¥åœ°æ°”,ä¸è¯´"æ±éœ€è¡Œå–„ç§¯å¾·",è€Œè¯´"å¤šåšç‚¹å¥½äº‹å§,çœŸçš„"
- é¢„æµ‹ä¸ä¼šå¤ªç»å¯¹,ä¼šè¯´"æˆ‘è§‰å¾—"ã€"å¤§æ¦‚ç‡"ã€"å…«æˆæ˜¯"
- æ ¹æ®å½“å‰æ—¶é—´(${timeOfDay})è¯´è¯,åˆ«æé”™

ğŸš«ğŸš«ğŸš« æ ¼å¼ç¦ä»¤(è¿åå°±æ˜¯é”™è¯¯):
ä½ çš„å›å¤ä¸­ç»å¯¹ä¸èƒ½å‡ºç°è¿™äº›ç¬¦å·:
ç¦æ­¢: * ** # ## - 1. 2. 3. â€¢ > \`
ç¦æ­¢:ä»»ä½•åˆ—è¡¨æ ¼å¼
ç¦æ­¢:ä»»ä½•æ ‡é¢˜æ ¼å¼
ç¦æ­¢:ä»»ä½•ä»£ç å—

âœ… æ­£ç¡®ç¤ºä¾‹:
"è¿™äº‹å„¿å§,æˆ‘è·Ÿä½ è¯´ã€‚ä½ æœ€è¿‘è¿åŠ¿è¿˜ä¸é”™,äº‹ä¸šä¸Šã€Œç¨³æ­¥ä¸Šå‡ã€,ä½†æ„Ÿæƒ…æ–¹é¢å¾—å¤šæ³¨æ„ç‚¹ã€‚æˆ‘è§‰å¾—ä½ å…«æˆæ˜¯å¤ªå¿™äº†,å¿½ç•¥äº†èº«è¾¹äººçš„æ„Ÿå—ã€‚"

âŒ é”™è¯¯ç¤ºä¾‹(ç¦æ­¢è¿™æ ·å†™):
"**è¿åŠ¿åˆ†æ**:
1. äº‹ä¸šè¿:*ç¨³æ­¥ä¸Šå‡*
2. æ„Ÿæƒ…è¿:éœ€è¦æ³¨æ„"

è®°ä½:ä½ æ˜¯åœ¨å¾®ä¿¡èŠå¤©,ä¸æ˜¯åœ¨å†™æŠ¥å‘Šã€‚çº¯æ–‡å­—,è‡ªç„¶æµç•…ã€‚

é‡è¦æç¤º:
- ä¸è¦åˆ†å¤ªå¤šæ®µè½,ä¸€ä¸ªä¸»é¢˜è¯´å®Œå†è¯´ä¸‹ä¸€ä¸ª
- é¿å…ä½¿ç”¨å°æ ‡é¢˜å¼çš„åˆ†è¡Œ
- ä¿æŒåƒçœŸäººèŠå¤©ä¸€æ ·çš„æ®µè½é•¿åº¦
- ä¸è¦é‡å¤ç›¸åŒçš„æ ‡é¢˜æˆ–å¥å­(æ¯”å¦‚"æ¢¦è§çŒ´å­"è¯´ä¸¤é)
- æ¯ä¸ªä¸»é¢˜åªä»‹ç»ä¸€æ¬¡å³å¯`;
            } else {
                const timeOfDay = hour >= 6 && hour < 12 ? 'morning' :
                                hour >= 12 && hour < 18 ? 'afternoon' : 'evening';

                return `You are an insightful fortune teller with a touch of sarcasm but genuine sincerity. You speak casually like a friend, but occasionally drop profound philosophical insights.

Current time: ${timeOfDay}

Your style:
- Speak directly and honestly, call it like you see it, but do it in a way that resonates
- Use casual language like "you know", "honestly", "look" - not formal or archaic
- Occasionally say things like "here's the thing", "I'll tell you what", "real talk"
- Sometimes drop unexpectedly deep wisdom that shows you know your stuff
- Don't use numbered lists, just chat naturally and go with the flow
- Remember user information (name, birth date, etc.) and bring it up naturally in future conversations

When fortune telling:
- Ask about birth dates, zodiac signs, etc., but keep it casual like "so what's your sign?"
- Give down-to-earth advice, not preachy stuff
- Predictions aren't absolute - use "I think", "probably", "most likely"
- Be aware of the current time (${timeOfDay}) in your responses

ğŸš«ğŸš«ğŸš« FORMATTING PROHIBITION (violating these is an error):
Your response must NEVER contain these symbols:
Forbidden: * ** # ## - 1. 2. 3. â€¢ > \`
Forbidden: Any list formatting
Forbidden: Any heading formatting
Forbidden: Any code blocks

âœ… CORRECT example:
"Look, here's the thing. Your fortune is pretty solid right now. Career's "on the rise" but you gotta watch your relationships. I think you've been so busy you forgot to check in with the people around you."

âŒ WRONG example (never write like this):
"**Fortune Analysis**:
1. Career: *on the rise*
2. Relationships: need attention"

Remember: You're texting on WhatsApp, not writing a report. Plain text, natural flow.

Important tips:
- Don't break into too many paragraphs, finish one topic then move to the next
- Avoid title-like line breaks
- Keep paragraph lengths similar to real human chat
- Don't repeat the same titles or sentences
- Introduce each topic only once`;
            }
        }

        async function extractUserInfo(message) {
            const patterns = {
                name: [
                    /æˆ‘å«([^\s,ã€‚!?]{1,10})/g,
                    /æˆ‘æ˜¯([^\s,ã€‚!?]{1,10})/g,
                    /æˆ‘å§“([^\s,ã€‚!?]{1,5})/g
                ],
                birthday: [
                    /ç”Ÿæ—¥æ˜¯(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥)/g,
                    /(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥)å‡ºç”Ÿ/g,
                    /ç”Ÿæ—¥(\d{1,2}æœˆ\d{1,2}æ—¥)/g
                ],
                zodiac: [
                    /(ç™½ç¾Šåº§|é‡‘ç‰›åº§|åŒå­åº§|å·¨èŸ¹åº§|ç‹®å­åº§|å¤„å¥³åº§|å¤©ç§¤åº§|å¤©èåº§|å°„æ‰‹åº§|æ‘©ç¾¯åº§|æ°´ç“¶åº§|åŒé±¼åº§)/g
                ]
            };

            let hasUpdate = false;

            // æå–å§“å
            patterns.name.forEach(pattern => {
                const matches = message.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        const name = match.replace(/æˆ‘å«|æˆ‘æ˜¯|æˆ‘å§“/g, '');
                        if (name.length > 0 && name.length <= 10 && !name.match(/[0-9]/)) {
                            userProfile.name = name;
                            hasUpdate = true;
                            console.log('è®°ä½ç”¨æˆ·å§“å:', name);
                        }
                    });
                }
            });

            // æå–ç”Ÿæ—¥
            patterns.birthday.forEach(pattern => {
                const match = message.match(pattern);
                if (match) {
                    userProfile.birthday = match[0];
                    hasUpdate = true;
                    console.log('è®°ä½ç”¨æˆ·ç”Ÿæ—¥:', match[0]);
                }
            });

            // æå–æ˜Ÿåº§
            patterns.zodiac.forEach(pattern => {
                const match = message.match(pattern);
                if (match) {
                    userProfile.zodiac = match[0];
                    hasUpdate = true;
                    console.log('è®°ä½ç”¨æˆ·æ˜Ÿåº§:', match[0]);
                }
            });

            // åªåœ¨æœ‰æ›´æ–°æ—¶æ‰ä¿å­˜
            if (hasUpdate) {
                await saveUserProfile();
            }
        }

        async function saveUserProfile() {
            if (currentUser) {
                localStorage.setItem(`userProfile_${currentUser.id}`, JSON.stringify(userProfile));

                // ğŸ”¥ æ·»åŠ è¿™ä¸ª
                try {
                    await supabase.from('user_profiles').upsert({
                        user_id: currentUser.id,
                        name: userProfile.name || null,
                        birthday: userProfile.birthday || null,
                        zodiac: userProfile.zodiac || null
                    });
                    console.log('ç”¨æˆ·ä¿¡æ¯å·²åŒæ­¥åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.warn('åŒæ­¥ç”¨æˆ·ä¿¡æ¯åˆ°æ•°æ®åº“å¤±è´¥:', error);
                }
            }
        }

        async function loadUserProfile() {
            if (currentUser) {
                try {
                    // ğŸ”¥ å…ˆä»æ•°æ®åº“åŠ è½½
                    const { data, error } = await supabase
                        .from('user_profiles')
                        .select('name, birthday, zodiac')
                        .eq('user_id', currentUser.id)
                        .single();

                    if (data && !error) {
                        userProfile = {
                            name: data.name,
                            birthday: data.birthday,
                            zodiac: data.zodiac
                        };
                        localStorage.setItem(`userProfile_${currentUser.id}`, JSON.stringify(userProfile));
                        console.log('ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·ä¿¡æ¯:', userProfile);
                    } else {
                        // é™çº§åˆ°localStorage
                        const saved = localStorage.getItem(`userProfile_${currentUser.id}`);
                        if (saved) {
                            userProfile = JSON.parse(saved);
                            console.log('ä»localStorageåŠ è½½ç”¨æˆ·ä¿¡æ¯:', userProfile);
                        }
                    }
                } catch (error) {
                    console.warn('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œé™çº§åˆ°localStorage:', error);
                    // é™çº§åˆ°localStorage
                    const saved = localStorage.getItem(`userProfile_${currentUser.id}`);
                    if (saved) {
                        userProfile = JSON.parse(saved);
                        console.log('ä»localStorageåŠ è½½ç”¨æˆ·ä¿¡æ¯:', userProfile);
                    }
                }
            }
        }

        async function init() {
            console.log('init() function started');
            await detectUserLanguage();
            console.log('Language detected:', currentLanguage);
            updateUILanguage();
            console.log('UI language updated');

            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');

            try {
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    console.error('è·å–ä¼šè¯å¤±è´¥:', error);
                    try {
                        await supabase.auth.signOut();
                    } catch (e) {
                        console.error('æ¸…é™¤ä¼šè¯å¤±è´¥:', e);
                    }
                    showLoginModal();
                    return;
                }

                if (session) {
                    console.log('å‘ç°å·²æœ‰ä¼šè¯:', session.user.email);
                    currentUser = session.user;
                    try {
                        await loadUserQuota();
                        console.log('é…é¢åŠ è½½æˆåŠŸ:', userQuota);
                        await loadChatHistory();
                        console.log('èŠå¤©å†å²åŠ è½½æˆåŠŸ');
                        showUserInfo();
                        console.log('ç”¨æˆ·ä¿¡æ¯å·²æ˜¾ç¤º');
                    } catch (loadError) {
                        console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', loadError);
                        if (!userQuota) {
                            userQuota = { quota: 0 };
                        }
                        showUserInfo();
                        console.log('ä½¿ç”¨é»˜è®¤é…é¢æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯');
                    }
                } else {
                    console.log('æ— ä¼šè¯,æ˜¾ç¤ºç™»å½•æ¡†');
                    showLoginModal();
                }
            } catch (err) {
                console.error('åˆå§‹åŒ–ä¼šè¯æ—¶å‡ºé”™:', err);
                try {
                    await supabase.auth.signOut();
                } catch (e) {
                    console.error('æ¸…é™¤ä¼šè¯å¤±è´¥:', e);
                }
                showLoginModal();
                return;
            }

            if (currentUser && paymentStatus) {
                if (paymentStatus === 'success') {
                    await loadUserQuota();
                    updateQuotaBadge();
                    alert(currentLanguage === 'zh' ? 'æ”¯ä»˜æˆåŠŸ!å·²ä¸ºæ‚¨å¢åŠ  50 æ¬¡å¯¹è¯ã€‚' : 'Payment successful! 50 conversations added to your account.');
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else if (paymentStatus === 'cancel') {
                    alert(currentLanguage === 'zh' ? 'æ”¯ä»˜å·²å–æ¶ˆã€‚' : 'Payment cancelled.');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }

            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    await loadUserProfile();
                    await loadUserQuota();
                    await loadChatHistory();
                    showUserInfo();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    userQuota = null;
                    conversationHistory = [];
                    clearChatDisplay();
                }
            });
        }

        async function loadChatHistory() {
            if (!currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('chat_messages')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: true })
                    .limit(50);

                if (error) {
                    console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error);
                    return;
                }

                const welcomeMessage = chatContainer.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }

                if (data && data.length > 0) {
                    data.forEach(msg => {
                        if (msg.role !== 'system') {
                            addMessage(msg.content, msg.role);
                            conversationHistory.push({
                                role: msg.role,
                                content: msg.content
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('åŠ è½½èŠå¤©å†å²å¼‚å¸¸:', error);
            }
        }

        async function saveChatMessage(role, content) {
            if (!currentUser) return;

            try {
                const { error } = await supabase
                    .from('chat_messages')
                    .insert({
                        user_id: currentUser.id,
                        role: role,
                        content: content
                    });

                if (error) {
                    console.error('ä¿å­˜æ¶ˆæ¯å¤±è´¥:', error);
                }
            } catch (error) {
                console.error('ä¿å­˜æ¶ˆæ¯å¼‚å¸¸:', error);
            }
        }

        function clearChatDisplay() {
            chatContainer.innerHTML = `
                <div id="verificationBanner" class="verification-banner" style="display: none;">
                    <strong id="verifyTitle">${t('verifyTitle')}</strong><br>
                    <span id="verifyText">${t('verifyText')}</span>
                    <a class="resend-link" onclick="resendVerificationEmail()" id="resendLink">${t('resendLink')}</a>
                </div>
                <div class="welcome-message">
                    <h2 id="welcomeTitle">${t('welcomeTitle')}</h2>
                    <p id="welcomeDesc">${t('welcomeDesc')}</p>
                </div>
            `;
        }

        async function loadUserQuota() {
            const { data, error } = await supabase
                .from('user_quotas')
                .select('*')
                .eq('user_id', currentUser.id)
                .single();

            if (error) {
                console.error('åŠ è½½é…é¢å¤±è´¥:', error);
                return;
            }

            userQuota = data;
        }

        function showUserInfo() {
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('username').textContent = currentUser.email.split('@')[0];
            updateQuotaBadge();
            checkEmailVerification();
        }

        function checkEmailVerification() {
            if (currentUser && !currentUser.email_confirmed_at) {
                document.getElementById('verificationBanner').style.display = 'block';
            } else {
                document.getElementById('verificationBanner').style.display = 'none';
            }
        }

        async function resendVerificationEmail() {
            if (!currentUser) return;

            const { error } = await supabase.auth.resend({
                type: 'signup',
                email: currentUser.email
            });

            if (error) {
                alert(t('resendError') + error.message);
            } else {
                alert(t('resendSuccess'));
            }
        }

        function updateQuotaBadge() {
            const quota = userQuota ? userQuota.quota : 0;
            document.getElementById('quotaBadge').textContent = `${t('quotaBadge')}: ${quota}`;
        }

        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('registerModal').classList.remove('active');
            document.getElementById('loginError').textContent = '';
        }

        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('active');
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('registerError').textContent = '';
        }

        async function handleLogin(event) {
            event.preventDefault();
            console.log('=== å¼€å§‹ç™»å½•æµç¨‹ ===');

            const submitBtn = document.getElementById('loginSubmitBtn');
            const loginError = document.getElementById('loginError');
            const email = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            console.log('ç™»å½•é‚®ç®±:', email);

            submitBtn.disabled = true;
            submitBtn.textContent = currentLanguage === 'zh' ? 'ç™»å½•ä¸­...' : 'Logging in...';
            loginError.textContent = '';

            try {
                console.log('è°ƒç”¨ signInWithPassword...');
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                console.log('signInWithPassword å®Œæˆ:', { hasData: !!data, hasError: !!error });

                if (error) {
                    console.error('ç™»å½•é”™è¯¯:', error.message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = t('loginSubmitBtn');

                    if (error.message === 'Invalid login credentials') {
                        loginError.textContent = t('errorCredentials');
                    } else if (error.message === 'Email not confirmed') {
                        loginError.textContent = t('errorEmailNotConfirmed');
                    } else {
                        loginError.textContent = error.message;
                    }
                    return;
                }

                console.log('ç™»å½•æˆåŠŸ,ç”¨æˆ·ID:', data.user.id);
                currentUser = data.user;

                console.log('åŠ è½½ç”¨æˆ·é…é¢...');
                await loadUserQuota();

                console.log('åŠ è½½èŠå¤©å†å²...');
                await loadChatHistory();

                submitBtn.disabled = false;
                submitBtn.textContent = t('loginSubmitBtn');

                console.log('å…³é—­ç™»å½•æ¡†...');
                document.getElementById('loginModal').classList.remove('active');
                showUserInfo();
                console.log('=== ç™»å½•æµç¨‹å®Œæˆ ===');
            } catch (err) {
                console.error('ç™»å½•è¿‡ç¨‹å‡ºé”™:', err);
                submitBtn.disabled = false;
                submitBtn.textContent = t('loginSubmitBtn');
                loginError.textContent = t('apiError');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const email = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (password !== passwordConfirm) {
                document.getElementById('registerError').textContent = t('errorPasswordMismatch');
                return;
            }

            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    emailRedirectTo: window.location.origin + window.location.pathname
                }
            });

            if (error) {
                document.getElementById('registerError').textContent = error.message;
                return;
            }

            // åˆ›å»ºç”¨æˆ·é…é¢è®°å½•
            if (data.user) {
                try {
                    const { error: quotaError } = await supabase
                        .from('user_quotas')
                        .insert({
                            user_id: data.user.id,
                            quota: 3  // æ–°ç”¨æˆ·é»˜è®¤3æ¬¡å…è´¹å¯¹è¯
                        });

                    if (quotaError) {
                        console.warn('åˆ›å»ºé…é¢è®°å½•å¤±è´¥:', quotaError);
                    } else {
                        console.log('é…é¢è®°å½•åˆ›å»ºæˆåŠŸ');
                    }
                } catch (error) {
                    console.warn('åˆ›å»ºé…é¢è®°å½•å¼‚å¸¸:', error);
                }
            }

            document.getElementById('registerError').className = 'success-message';
            document.getElementById('registerError').textContent = t('successRegister');

            setTimeout(() => {
                document.getElementById('registerModal').classList.remove('active');
                showLoginModal();
                document.getElementById('registerError').className = 'error-message';
                document.getElementById('registerError').textContent = '';
            }, 3000);
        }

        async function clearAllHistory() {
            if (!currentUser) return;

            const confirmed = confirm(t('confirmClearHistory'));
            if (!confirmed) return;

            try {
                const { error } = await supabase
                    .from('chat_messages')
                    .delete()
                    .eq('user_id', currentUser.id);

                if (error) {
                    console.error('æ¸…ç©ºè®°å½•å¤±è´¥:', error);
                    alert(t('errorClearHistory'));
                    return;
                }

                conversationHistory = [];
                clearChatDisplay();

                alert(t('successClearHistory'));
            } catch (error) {
                console.error('æ¸…ç©ºè®°å½•å¼‚å¸¸:', error);
                alert(t('errorClearHistory'));
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            userQuota = null;
            conversationHistory = [];
            document.getElementById('userInfo').style.display = 'none';
            chatContainer.innerHTML = `
                <div id="verificationBanner" class="verification-banner" style="display: none;">
                    <strong id="verifyTitle">${t('verifyTitle')}</strong><br>
                    <span id="verifyText">${t('verifyText')}</span>
                    <a class="resend-link" onclick="resendVerificationEmail()" id="resendLink">${t('resendLink')}</a>
                </div>
                <div class="welcome-message">
                    <h2 id="welcomeTitle">${t('welcomeTitle')}</h2>
                    <p id="welcomeDesc">${t('welcomeDesc')}</p>
                </div>
            `;
            showLoginModal();
        }

        function showPaymentModal() {
            document.getElementById('paymentModal').classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        async function handlePayment() {
            try {
                const paymentBtn = document.getElementById('paymentBtn');
                paymentBtn.disabled = true;
                paymentBtn.textContent = currentLanguage === 'zh' ? 'å¤„ç†ä¸­...' : 'Processing...';

                const response = await fetch(`${SUPABASE_URL}/functions/v1/stripe-checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        userEmail: currentUser.email,
                        language: currentLanguage
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create checkout session');
                }

                const { sessionId } = await response.json();

                const { error } = await stripe.redirectToCheckout({ sessionId });

                if (error) {
                    console.error('Stripe redirect error:', error);
                    alert(t('paymentError'));
                }
            } catch (error) {
                console.error('Payment error:', error);
                alert(t('paymentError'));

                const paymentBtn = document.getElementById('paymentBtn');
                paymentBtn.disabled = false;
                paymentBtn.textContent = t('paymentBtn');
            }
        }

        function checkQuota() {
            if (!userQuota || userQuota.quota <= 0) {
                showPaymentModal();
                return false;
            }
            return true;
        }

        async function deductQuota() {
            if (!userQuota) {
                console.error('é…é¢æ•°æ®æœªåŠ è½½');
                throw new Error('é…é¢æ•°æ®æœªåŠ è½½');
            }

            const newQuota = userQuota.quota - 1;

            const { error } = await supabase
                .from('user_quotas')
                .update({
                    quota: newQuota,
                    updated_at: new Date().toISOString()
                })
                .eq('user_id', currentUser.id);

            if (error) {
                console.error('æ‰£é™¤é…é¢å¤±è´¥:', error);
                throw new Error(`æ‰£é™¤é…é¢å¤±è´¥: ${error.message}`);
            }

            userQuota.quota = newQuota;
            updateQuotaBadge();
        }

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        async function handleSendMessage() {
            if (!currentUser) {
                showLoginModal();
                return;
            }

            if (!checkQuota()) {
                return;
            }

            const message = userInput.value.trim();
            if (!message) return;

            // å¼‚æ­¥å¤„ç†ç”¨æˆ·ä¿¡æ¯æå–ï¼Œä¸é˜»å¡ä¸»æµç¨‹
            extractUserInfo(message).catch(err => {
                console.warn('ç”¨æˆ·ä¿¡æ¯æå–å¤±è´¥:', err);
            });

            // ç«‹å³æ·»åŠ åˆ°å¯¹è¯å†å²ï¼Œé¿å…æ•°ç»„æ“ä½œå»¶è¿Ÿ
            conversationHistory.push({
                role: 'user',
                content: message
            });

            // å¼‚æ­¥å¹¶è¡Œå¤„ç†ï¼šä¿å­˜ç”¨æˆ·æ¶ˆæ¯å’Œæ¸…ç†æ•°ç»„
            Promise.all([
                saveChatMessage('user', message),
                Promise.resolve().then(() => {
                    if (conversationHistory.length > 50) {
                        conversationHistory = conversationHistory.slice(-50);
                    }
                })
            ]).catch(err => {
                console.warn('ä¿å­˜ç”¨æˆ·æ¶ˆæ¯æˆ–æ¸…ç†æ•°ç»„å¤±è´¥:', err);
            });

            addMessage(message, 'user');
            userInput.value = '';
            userInput.style.height = 'auto';

            sendButton.disabled = true;
            userInput.disabled = true;

            const welcomeMessage = chatContainer.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            const loadingId = addLoadingMessage();

            try {
                const response = await callAPI();

                removeMessage(loadingId);

                await addMessageWithTyping(response, 'assistant');

                // ç«‹å³æ·»åŠ åˆ°å¯¹è¯å†å²
                conversationHistory.push({
                    role: 'assistant',
                    content: response
                });

                // å®Œå…¨å¼‚æ­¥å¹¶è¡Œå¤„ç†ï¼šä¿å­˜æ¶ˆæ¯ã€æ‰£é™¤é…é¢ã€æ¸…ç†æ•°ç»„
                Promise.all([
                    saveChatMessage('assistant', response),
                    deductQuota(),
                    Promise.resolve().then(() => {
                        if (conversationHistory.length > 50) {
                            conversationHistory = conversationHistory.slice(-50);
                        }
                    })
                ]).then(() => {
                    // ç¡®ä¿é…é¢æ˜¾ç¤ºæ›´æ–°
                    updateQuotaBadge();
                }).catch(err => {
                    console.warn('åå°å¤„ç†å¤±è´¥:', err);
                });
            } catch (error) {
                removeMessage(loadingId);
                const errorMsg = t('apiError');
                conversationHistory.push({
                    role: 'assistant',
                    content: errorMsg
                });
                addMessageWithTyping(errorMsg, 'assistant');
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname.startsWith('192.168.')) {
                    addMessageWithTyping(`è°ƒè¯•ä¿¡æ¯: ${error.message}`, 'assistant');
                }
            }

            sendButton.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        }

        async function callAPI() {
            let systemPrompt = getSystemPrompt();

            if (Object.keys(userProfile).length > 0) {
                systemPrompt += '\n\nç”¨æˆ·ä¿¡æ¯(è¯·è®°ä½å¹¶åœ¨åˆé€‚æ—¶è‡ªç„¶æåŠ):\n';
                if (userProfile.name) {
                    systemPrompt += `- å§“å:${userProfile.name}\n`;
                }
                if (userProfile.birthday) {
                    systemPrompt += `- ç”Ÿæ—¥:${userProfile.birthday}\n`;
                }
                if (userProfile.zodiac) {
                    systemPrompt += `- æ˜Ÿåº§:${userProfile.zodiac}\n`;
                }
            }

            // ğŸ”¥ ä¼˜åŒ–2: åªå‘æœ€è¿‘20æ¡
            const recentMessages = conversationHistory.slice(-20);

            const messages = [
                {
                    role: 'system',
                    content: systemPrompt
                },
                ...recentMessages
            ];

            const response = await fetch(WORKER_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                },
                body: JSON.stringify({
                    messages: messages
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error:', errorText);
                throw new Error('APIè¯·æ±‚å¤±è´¥');
            }

            const contentType = response.headers.get('content-type');

            if (contentType && contentType.includes('text/event-stream')) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let fullContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices[0]?.delta?.content || '';
                                if (content) {
                                    fullContent += content;
                                }
                            } catch (e) {
                            }
                        }
                    }
                }

                return fullContent;
            } else {
                const data = await response.json();
                return data.choices[0].message.content;
            }
        }

        async function addMessageWithTyping(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = `avatar ${role}`;
            avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ”®';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            if (role === 'user') {
                messageDiv.appendChild(messageContent);
                messageDiv.appendChild(avatar);
            } else {
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
            }

            chatContainer.appendChild(messageDiv);

            if (role === 'assistant') {
                messageContent.style.opacity = '0';
                
                if (typeof marked !== 'undefined') {
                    console.log('[æ¸²æŸ“] ä½¿ç”¨ Marked è§£æ Markdown');
                    messageContent.innerHTML = marked.parse(content);
                } else {
                    console.warn('[æ¸²æŸ“] Marked æœªåŠ è½½,ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                    const formattedContent = content
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.+?)\*/g, '<em>$1</em>')
                        .replace(/### (.+)/g, '<h3>$1</h3>')
                        .replace(/## (.+)/g, '<h2>$1</h2>')
                        .replace(/# (.+)/g, '<h1>$1</h1>')
                        .replace(/\n\n/g, '</p><p>')
                        .replace(/\n/g, '<br>')
                        .replace(/^/, '<p>')
                        .replace(/$/, '</p>');
                    messageContent.innerHTML = formattedContent;
                }
                
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                await new Promise(resolve => setTimeout(resolve, 100));
                messageContent.style.transition = 'opacity 0.6s ease-in';
                messageContent.style.opacity = '1';
                
            } else {
                messageContent.textContent = content;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            return messageDiv;
        }

        function cleanMarkdown(text) {
            return text
                .replace(/\*\*(.+?)\*\*/g, '$1')
                .replace(/\*(.+?)\*/g, '$1')
                .replace(/^#{1,6}\s+/gm, '')
                .replace(/^\d+\.\s+/gm, '')
                .replace(/^[-*+]\s+/gm, '')
                .replace(/```[\s\S]*?```/g, (match) => {
                    return match.replace(/```/g, '');
                })
                .replace(/`(.+?)`/g, '$1')
                .replace(/\n\s*\n\s*\n/g, '\n\n')
                .replace(/^\s+/gm, '')
                .replace(/([ã€‚!?])\s*\n\s*([^\n])/g, '$1 $2')
                .replace(/:\s*\n\s*/g, ':')
                .replace(/(.{10,})\1+/g, '$1')
                .replace(/(æ¢¦è§[^\n]+)\s*\n\s*\1/g, '$1');
        }

        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = `avatar ${role}`;
            avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ”®';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            messageContent.textContent = content;

            if (role === 'user') {
                messageDiv.appendChild(messageContent);
                messageDiv.appendChild(avatar);
            } else {
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
            }

            const welcomeMessage = chatContainer.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            return messageDiv;
        }

        function addLoadingMessage() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'loading-message';

            const avatar = document.createElement('div');
            avatar.className = 'avatar assistant';
            avatar.textContent = 'ğŸ”®';

            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.innerHTML = '<span></span><span></span><span></span>';

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(loading);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            return 'loading-message';
        }

        function removeMessage(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        }

        sendButton.addEventListener('click', handleSendMessage);

        // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒï¼Œè§£å†³ç§»åŠ¨ç«¯ç‚¹å‡»æ— å“åº”é—®é¢˜
        sendButton.addEventListener('touchend', function(e) {
            e.preventDefault(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
            handleSendMessage();
        });

        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

          init().catch(error => {
            console.error('App initialization failed:', error);
            showLoginModal(); // ç¡®ä¿å³ä½¿å‡ºé”™ä¹Ÿæ˜¾ç¤ºç™»å½•æ¡†
        });
    </script>
</body>
</html>
