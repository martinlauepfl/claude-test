# 从零开始打造AI算命大师：我的独立开发之旅

## 📖 项目概述

"玄机阁"是一个结合传统命理与现代AI技术的智能算命应用。用户可以通过与AI大师对话，获得基于易经、八卦、风水等传统智慧的人生指引。

## 🎯 项目初心

一直觉得传统文化中的命理学很有意思，但现代人与其接触太少。我想用AI技术让这些古老的智慧重新焕发生机，让年轻人也能轻松了解和体验传统命理文化的魅力。

## 🛠 技术栈选择

### 前端架构
- **纯HTML单文件**：没有使用React/Vue，直接在一个HTML文件里完成所有功能
- **为什么这么选？**
  - 部署简单，直接扔到GitHub Pages就能用
  - 不需要复杂的构建流程，开发效率高
  - 对于这种工具型应用，单文件足够了

### 后端服务
- **Supabase**：一个Firebase的替代品
  - 用户认证（注册/登录）
  - 数据库存储（聊天记录、用户额度）
  - Edge Functions（类似云函数）
  - 完全免费额度够用

### AI模型
- **阿里云通义千问**：国产大模型，中文理解能力强
- **通过Edge Function调用**：保护API密钥安全

## 🚀 开发过程全记录

### 第一阶段：基础功能搭建（1周）

#### 1. 用户系统
```javascript
// 使用Supabase实现用户认证
const { data, error } = await supabase.auth.signInWithPassword({
  email: email,
  password: password
})
```

遇到的坑：
- 邮箱验证功能要单独配置
- RLS（行级安全）策略容易忘记设置

#### 2. 聊天界面
- 实现了打字机效果的流式输出
- 参考了很多AI产品的UI设计
- 加入了暗色主题，营造神秘氛围

#### 3. 额度管理系统
```sql
CREATE TABLE user_quotas (
  user_id UUID REFERENCES auth.users(id),
  quota INTEGER DEFAULT 2,  -- 新用户送2次
  total_purchased INTEGER DEFAULT 0
);
```

### 第二阶段：AI对话集成（3天）

#### 1. Edge Function开发
```typescript
// supabase/functions/ai-chat/index.ts
const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${Deno.env.get('ALIBABA_API_KEY')}`
  },
  body: JSON.stringify({
    model: 'qwen-max',
    messages: messages,
    stream: true  // 流式输出
  })
})
```

#### 2. 系统提示词设计
花了很多时间调试AI的人设：
```
你是玄机阁的AI算命大师，精通易经八卦、命理风水。
说话要：
- 有神秘感但不要迷信
- 用一些古风词汇但不要太晦涩
- 给出实用建议
- 偶尔引用古诗词
```

### 第三阶段：支付系统（2天）

集成了Stripe支付：
- 创建了支付Session
- 处理Webhook回调
- 更新用户额度

踩过的坑：
- Webhook端点验证失败
- 测试环境要用测试卡号
- 汇率转换要注意

### 第四阶段：RAG知识库增强（1周）

这是最有趣的部分！让AI不只是通用的聊天，而是真正懂传统命理。

#### 1. 准备知识库
收集了传统命理资料：
- 《易经》全文及64卦详解
- 《梅花易数》占卜方法
- 风水基础知识
- 面相手相图谱
- 周公解梦大全
- 十二星座运势

#### 2. 向量化处理
```python
# 使用阿里云embedding模型
import requests

def generate_embedding(text):
    response = requests.post(
        "https://dashscope.aliyuncs.com/api/v1/services/embeddings/text-embedding/text-embedding",
        headers={"Authorization": f"Bearer {API_KEY}"},
        json={
            "model": "text-embedding-v4",
            "input": {"texts": [text]},
            "parameters": {"dimension": 1024}  # 注意是dimension不是dimensions！
        }
    )
    return response.json()["output"]["embeddings"][0]["embedding"]
```

踩过的坑：
- 一开始用`dimensions`参数，一直报错
- 后来发现应该是`dimension`（单数）
- API有QPS限制，要控制请求频率

#### 3. 相似度搜索
```sql
-- 使用pgvector扩展
SELECT *, 1 - (embedding <=> query_vector) as similarity
FROM knowledge_base
WHERE 1 - (embedding <=> query_vector) > 0.5
ORDER BY similarity DESC
LIMIT 5;
```

#### 4. RAG对话流程
1. 用户输入问题
2. 向量化用户问题
3. 在知识库中搜索相关内容
4. 将搜索结果作为上下文
5. AI结合上下文生成回答

## 💡 关键技术决策

### 1. 为什么选择单文件架构？
- 快速开发：不需要配置复杂的环境
- 易于部署：一个文件搞定
- 性能足够：应用逻辑不复杂
- SEO友好：更容易做搜索引擎优化

### 2. 为什么用Supabase而不是Firebase？
- Supabase开源，更透明
- 支持PostgreSQL，可以做向量搜索
- Edge Functions支持Deno，类型安全
- 国内访问速度更快

### 3. 为什么选择阿里云而不是OpenAI？
- 中文理解更准确
- 价格更便宜
- 服务在国内，延迟低
- 支持向量embedding模型

## 📊 项目数据

### 代码量
- `index.html`: 75KB（包含所有前端逻辑）
- Edge Functions: 7个，总计约1000行代码
- 知识库: 1402条记录，涵盖6大类命理内容

### 成本
- 域名：¥60/年
- Supabase：免费额度足够
- 阿里云API：按量付费，月均¥50-100
- 总成本：<¥200/月

## 🎨 设计思考

### UI/UX设计
1. **暗色主题**：营造神秘氛围
2. **渐变背景**：模拟星空效果
3. **打字机效果**：增加AI对话的真实感
4. **响应式设计**：移动端友好

### 用户体验优化
- 新用户赠送体验次数
- 聊天记录自动保存
- 支持清空历史记录
- 流式输出减少等待焦虑

## 🚀 部署过程

### GitHub Pages自动部署
```bash
git add .
git commit -m "update"
git push
# 自动触发GitHub Pages构建
```

### Supabase配置
1. 创建项目和数据库表
2. 设置RLS策略
3. 部署Edge Functions
4. 配置环境变量

### 域名解析
- GitHub Pages设置CNAME
- Cloudflare CDN加速
- SSL证书自动配置

## 🆕 2025年11月更新

### RAG系统重大突破
经过多轮迭代优化，RAG系统取得重大进展：

1. **AI直接引用古籍功能实现**
   - 解决了401认证错误，将RAG检索集成到ai-chat-with-rag函数内部
   - AI现在能直接引用古籍原文，如"梦见蛇是凶兆"、"梦见蛇咬你自己，要交好运"等
   - 回答结尾自动标注知识来源：「📚 此回答基于 X 条古籍记载」

2. **技术优化要点**
   - 相似度阈值从0.75降低到0.5，获得更多相关知识
   - 固定返回前3条最相关内容
   - 使用Supabase客户端直接调用match_knowledge RPC函数
   - 知识上下文注入到System Prompt中，确保AI必须参考

3. **测试验证通过**
   - 测试"梦见蛇是什么征兆？"成功返回7条古籍内容
   - AI回答专业且准确，保持了算命大师的风格
   - 系统响应速度良好，用户体验流畅

4. **项目清理**
   - 删除了14个不必要的测试文件和文档
   - 保留了核心代码和重要文档
   - 项目结构更加清晰整洁

### 代码质量改进
- 修复了TypeScript类型错误
- 优化了错误处理机制
- 添加了详细的日志记录
- 统一了代码风格

### 知识库状态
- 总记录：1402条（已去重）
- 向量覆盖：100%（1024维）
- 分类：易经、风水、解梦、面相手相、星座、梅花易数

### 2025年11月10日：用户体验全面优化

#### 1. 语言检测系统重构
**解决的核心问题**：首次访问用户看到中文→英文的闪烁体验

**技术实现**：
- 添加全局Loading屏幕，页面加载时先显示旋转动画
- 更换IP检测API从`ipapi.co`到`api.country.is`（支持CORS）
- 优化语言检测逻辑：
  ```javascript
  // 首次访问：null（不预设默认值）
  let currentLanguage = localStorage.getItem('language');

  // 回访用户：直接从localStorage读取
  if (savedLanguage) {
      document.title = savedLanguage === 'zh' ? 'AI算命大师' : 'AI Fortune Teller';
  }
  ```
- 修复fallback逻辑bug：`'zh' : 'zh'` → `'zh' : 'en'`

**用户体验提升**：
- 首次访问：Loading → IP检测 → 正确语言（无闪烁）
- 回访用户：直接显示正确语言（0闪烁）
- 新加坡等非中国地区用户默认显示英文界面

**调试优化**：
```javascript
console.log('🌐 Browser language:', browserLang, '| Is Chinese:', isChinese);
console.log('✅ IP detection success | Country:', data.country, '| Language:', currentLanguage);
```

#### 2. 移动端体验优化

**输入框文字重叠问题**：
- 问题：移动端输入长文本时，文字会与发送按钮重叠
- 解决：将padding-right从60px增加到70px
- 效果：文字与按钮保持充足间距

**发送按钮位置精调**：
- 桌面端：`bottom: 11.75px`（精确对齐）
- 移动端：`bottom: 9.5px`（视觉平衡）
- 统一右侧距离：`right: 12px`

**输入框高度修复**：
- 问题：发送消息后输入框缩小到20-30px
- 原因：`userInput.style.height = 'auto'` 导致高度重置
- 解决：改为 `userInput.style.height = '56px'`
- 效果：发送后保持初始高度，体验流畅

#### 3. 输入框固定定位优化

**问题**：桌面端输入框随页面滚动，不符合现代聊天应用习惯

**解决方案**：
```css
.input-area {
    position: fixed;  /* 从relative改为fixed */
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 10;
}

.chat-container {
    padding: 32px 20px 140px 20px;  /* 底部padding防止遮挡 */
}
```

**效果**：
- 输入框固定在页面底部，类似ChatGPT体验
- 滚动聊天记录时，输入框保持原位
- 最后一条消息不会被输入框遮挡

#### 4. 配额显示逻辑优化

**优化前**：
- 配额加载失败显示 `0`
- 用户无法区分"真的没配额"和"加载失败"

**优化后**：
```javascript
const quota = userQuota ? userQuota.quota : '--';
document.getElementById('quotaBadge').textContent = `${t('quotaBadge')}: ${quota}`;
```

**用户体验**：
- `--` = 加载失败，建议刷新
- `0` = 真的没配额了，需要充值
- `数字` = 剩余次数

#### 5. UI细节打磨

**简化Placeholder**：
- 中文：`"说说你的困惑,我为你指点迷津..."` → `"问我任何问题..."`
- 英文：`"Share your questions, let me guide you..."` → `"Ask me anything..."`
- 更简洁，更现代

**代码清理**：
- 删除空的CSS规则集（`:hover`和`:active`）
- 清理未使用的函数
- 优化代码可读性

#### 技术细节记录

**CORS问题处理**：
```javascript
// ipapi.co在localhost环境会被CORS阻止
// 更换为api.country.is解决
fetch('https://api.country.is/')
  .then(res => res.json())
  .then(data => {
      // data.country: 'CN', 'SG', 'US' etc.
  })
```

**Loading状态管理**：
```css
body {
    opacity: 0;  /* 初始隐藏 */
}

.app-loading {
    position: fixed;
    display: flex;
    z-index: 9999;
}

.app-content {
    opacity: 0;
}

.app-content.visible {
    opacity: 1;
    transition: opacity 0.3s ease;
}
```

**响应式定位**：
```css
/* 桌面端 */
.send-button {
    bottom: 11.75px;
}

/* 移动端 */
@media (max-width: 768px) {
    .send-button {
        bottom: 9.5px !important;
    }
}
```

#### 性能优化记录

**代码统计**：
- HTML文件大小：87KB（增加4KB，主要是Loading屏幕）
- JavaScript性能：无明显影响
- 首屏加载时间：≈800ms（包含IP检测）

**优化效果**：
- 语言闪烁问题：100%解决
- 移动端体验：显著提升
- 用户反馈：无卡顿现象

#### 遗留问题与后续优化

**已知限制**：
1. localhost环境下Supabase请求可能超时（生产环境正常）
2. IP检测依赖第三方API，可能有延迟
3. 首次访问需要等待IP检测完成（≈1-2秒）

**后续优化方向**：
1. 添加骨架屏代替纯Loading旋转
2. IP检测失败时更智能的降级策略
3. 考虑使用Cloudflare Workers做IP检测
4. 添加用户手动切换语言的入口

## 🔮 未来规划

### 短期优化
1. 增加语音输入/输出
2. 添加更多命理门类
3. 优化RAG搜索算法
4. 增加历史记录导出
5. 扩充知识库，增加更多古籍内容

### 长期愿景
1. 开发小程序版本
2. 增加直播算命功能
3. 培训专业命理师
4. 建立命理知识社区

## 💭 开发感悟

1. **MVP思维**：先做最小可用版本，再迭代优化
2. **技术选型**：适合的才是最好的，不必追求最新最炫
3. **用户体验**：细节决定成败，多从用户角度思考
4. **持续学习**：AI领域发展快，要保持学习热情

## 🎯 给独立开发者的建议

1. **从痛点出发**：找到真实需求，不要为了技术而技术
2. **快速验证**：先做原型验证想法，再投入大量时间
3. **控制成本**：善用免费服务，避免过早投入
4. **注重增长**：产品再好也要有用户，早期就要考虑推广
5. **保持热情**：独立开发是马拉松，不是短跑

---

## 🔗 相关链接

- 产品地址：https://ai-fortune.top
- GitHub仓库：[私有]
- 技术博客：[持续更新中]

*如果你也对AI+传统文化感兴趣，欢迎交流！*