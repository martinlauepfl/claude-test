<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•å…ƒæµ‹è¯• - AIç®—å‘½åº”ç”¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .content {
            padding: 30px;
        }

        .test-group {
            margin-bottom: 30px;
        }

        .test-group-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .test-case {
            background: #f8f9fa;
            border-left: 4px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .test-case.pass {
            border-left-color: #10b981;
            background: #d1fae5;
        }

        .test-case.fail {
            border-left-color: #ef4444;
            background: #fee2e2;
        }

        .test-name {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .test-status.pass {
            background: #10b981;
            color: white;
        }

        .test-status.fail {
            background: #ef4444;
            color: white;
        }

        .test-details {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            font-family: monospace;
        }

        .test-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 13px;
            color: #991b1b;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .run-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 20px 0;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s;
        }

        .run-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .run-button:active {
            transform: translateY(0);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #667eea;
        }

        .loading.active {
            display: block;
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª å•å…ƒæµ‹è¯•</h1>
            <p>æµ‹è¯•å·²ä¿®å¤çš„8ä¸ªé—®é¢˜åŠæ ¸å¿ƒåŠŸèƒ½</p>
            <div class="stats">
                <div class="stat">
                    <span class="stat-number" id="passCount">0</span>
                    <span class="stat-label">é€šè¿‡</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="failCount">0</span>
                    <span class="stat-label">å¤±è´¥</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="totalCount">0</span>
                    <span class="stat-label">æ€»è®¡</span>
                </div>
            </div>
        </div>

        <div class="content">
            <button class="run-button" onclick="runAllTests()">â–¶ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>

            <div class="loading" id="loading">
                <p>â³ æµ‹è¯•è¿›è¡Œä¸­...</p>
            </div>

            <div class="results" id="results"></div>
        </div>
    </div>

    <script>
        // ğŸ”¥ ä»index.htmlå¤åˆ¶éœ€è¦æµ‹è¯•çš„å‡½æ•°

        // ä¿®å¤2ï¼šlocalStorageå®‰å…¨åŒ…è£…
        function safeSetLocalStorage(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                console.warn('localStorageä¸å¯ç”¨ï¼ˆå¯èƒ½æ˜¯éšç§æ¨¡å¼ï¼‰:', e);
                return false;
            }
        }

        function safeGetLocalStorage(key, defaultValue = null) {
            try {
                return localStorage.getItem(key) || defaultValue;
            } catch (e) {
                console.warn('localStorageä¸å¯ç”¨ï¼ˆå¯èƒ½æ˜¯éšç§æ¨¡å¼ï¼‰:', e);
                return defaultValue;
            }
        }

        // ä¿®å¤4ï¼šç”¨æˆ·ä¿¡æ¯æå–ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function extractName(message) {
            const blacklist = ['ä½ ', 'æ‚¨', 'ä»–', 'å¥¹', 'å®ƒ', 'æˆ‘ä»¬', 'ä½ ä»¬', 'ä»–ä»¬', 'å¤§å®¶', 'åˆ«äºº', 'è‡ªå·±',
                               'ä¸è¦', 'è¦ä¸', 'æ˜å¤©', 'ä»Šå¤©', 'æ˜¨å¤©', 'ä»€ä¹ˆ', 'æ€ä¹ˆ', 'å“ªé‡Œ'];

            const patterns = [
                /æˆ‘å«([^\s,ã€‚!?]{1,10})/g,
                /æˆ‘æ˜¯([^\s,ã€‚!?]{1,10})/g,
                /æˆ‘å§“([^\s,ã€‚!?]{1,5})/g
            ];

            for (const pattern of patterns) {
                const matches = message.match(pattern);
                if (matches) {
                    for (const match of matches) {
                        const name = match.replace(/æˆ‘å«|æˆ‘æ˜¯|æˆ‘å§“/g, '');
                        if (name.length > 0 && name.length <= 4 &&
                            !name.match(/[0-9]/) &&
                            !blacklist.includes(name) &&
                            !blacklist.some(word => name.includes(word))) {
                            return name;
                        }
                    }
                }
            }
            return null;
        }

        // æµ‹è¯•æ¡†æ¶
        let passCount = 0;
        let failCount = 0;
        let results = [];

        function assert(condition, testName, details = '') {
            if (condition) {
                passCount++;
                results.push({
                    status: 'pass',
                    name: testName,
                    details: details
                });
            } else {
                failCount++;
                results.push({
                    status: 'fail',
                    name: testName,
                    details: details,
                    error: 'Assertion failed'
                });
            }
        }

        function assertEqual(actual, expected, testName) {
            const passed = actual === expected;
            const details = `æœŸæœ›: ${JSON.stringify(expected)}, å®é™…: ${JSON.stringify(actual)}`;

            if (passed) {
                passCount++;
                results.push({
                    status: 'pass',
                    name: testName,
                    details: details
                });
            } else {
                failCount++;
                results.push({
                    status: 'fail',
                    name: testName,
                    details: details,
                    error: `å€¼ä¸åŒ¹é…`
                });
            }
        }

        function assertNotNull(value, testName) {
            assert(value !== null && value !== undefined, testName, `å€¼: ${value}`);
        }

        // æµ‹è¯•å¥—ä»¶
        function testGroup1_LocalStorage() {
            console.log('ğŸ§ª æµ‹è¯•ç»„1: localStorageå®‰å…¨åŒ…è£…');

            // æµ‹è¯•æ­£å¸¸æƒ…å†µ
            const key = 'test_key_' + Date.now();
            const value = 'test_value';

            const setResult = safeSetLocalStorage(key, value);
            assertEqual(setResult, true, '1.1 localStorageå¯ç”¨æ—¶åº”è¿”å›true');

            const getResult = safeGetLocalStorage(key);
            assertEqual(getResult, value, '1.2 åº”èƒ½æ­£ç¡®è¯»å–å­˜å‚¨çš„å€¼');

            // æµ‹è¯•é»˜è®¤å€¼
            const defaultResult = safeGetLocalStorage('non_existent_key', 'default');
            assertEqual(defaultResult, 'default', '1.3 ä¸å­˜åœ¨çš„é”®åº”è¿”å›é»˜è®¤å€¼');

            // æ¸…ç†
            try {
                localStorage.removeItem(key);
            } catch (e) {}
        }

        function testGroup2_NameExtraction() {
            console.log('ğŸ§ª æµ‹è¯•ç»„2: ç”¨æˆ·å§“åæå–');

            // æ­£å¸¸æƒ…å†µ
            assertEqual(extractName('ä½ å¥½ï¼Œæˆ‘å«å¼ ä¸‰'), 'å¼ ä¸‰', '2.1 åº”æ­£ç¡®æå–"æˆ‘å«å¼ ä¸‰"');
            assertEqual(extractName('å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯æå››'), 'æå››', '2.2 åº”æ­£ç¡®æå–"æˆ‘æ˜¯æå››"');
            assertEqual(extractName('æˆ‘å§“ç‹'), 'ç‹', '2.3 åº”æ­£ç¡®æå–"æˆ‘å§“ç‹"');

            // è¯¯åˆ¤è¿‡æ»¤
            assertEqual(extractName('æˆ‘å«ä½ æ˜å¤©æ¥'), null, '2.4 åº”è¿‡æ»¤"æˆ‘å«ä½ æ˜å¤©æ¥"ï¼ˆåŒ…å«é»‘åå•è¯"ä½ "ï¼‰');
            assertEqual(extractName('æˆ‘å«ä»–ä¸è¦å»'), null, '2.5 åº”è¿‡æ»¤"æˆ‘å«ä»–ä¸è¦å»"ï¼ˆåŒ…å«é»‘åå•è¯"ä»–"ï¼‰');
            assertEqual(extractName('æˆ‘æ˜¯ä»€ä¹ˆæ˜Ÿåº§'), null, '2.6 åº”è¿‡æ»¤"æˆ‘æ˜¯ä»€ä¹ˆæ˜Ÿåº§"ï¼ˆåŒ…å«é»‘åå•è¯"ä»€ä¹ˆ"ï¼‰');

            // è¾¹ç•Œæƒ…å†µ
            assertEqual(extractName('æˆ‘å«ç‹å°æ˜åŒå­¦'), null, '2.7 åº”è¿‡æ»¤è¶…è¿‡4ä¸ªå­—çš„åå­—');
            assertEqual(extractName('æˆ‘å«abc123'), null, '2.8 åº”è¿‡æ»¤åŒ…å«æ•°å­—çš„åå­—');
            assertEqual(extractName('æˆ‘æ˜¯'), null, '2.9 åº”è¿‡æ»¤ç©ºåå­—');
        }

        function testGroup3_JSONParse() {
            console.log('ğŸ§ª æµ‹è¯•ç»„3: JSON.parseå®¹é”™å¤„ç†');

            // æ­£å¸¸JSON
            try {
                const validJson = '{"name":"å¼ ä¸‰","age":30}';
                const result = JSON.parse(validJson);
                assertEqual(result.name, 'å¼ ä¸‰', '3.1 åº”æ­£ç¡®è§£ææœ‰æ•ˆJSON');
            } catch (e) {
                failCount++;
                results.push({
                    status: 'fail',
                    name: '3.1 åº”æ­£ç¡®è§£ææœ‰æ•ˆJSON',
                    error: e.message
                });
            }

            // æŸåçš„JSONï¼ˆæ¨¡æ‹Ÿå®¹é”™é€»è¾‘ï¼‰
            function safeJSONParse(str) {
                try {
                    return JSON.parse(str);
                } catch (e) {
                    console.warn('JSONè§£æå¤±è´¥:', e);
                    return {};
                }
            }

            const invalidJson = '{name: "å¼ ä¸‰"';  // æŸåçš„JSON
            const fallbackResult = safeJSONParse(invalidJson);
            assertEqual(JSON.stringify(fallbackResult), '{}', '3.2 æŸåçš„JSONåº”è¿”å›ç©ºå¯¹è±¡');
        }

        function testGroup4_InputValidation() {
            console.log('ğŸ§ª æµ‹è¯•ç»„4: è¾“å…¥éªŒè¯');

            // é‚®ç®±éªŒè¯ï¼ˆç®€åŒ–ï¼‰
            function isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            assertEqual(isValidEmail('test@example.com'), true, '4.1 æœ‰æ•ˆé‚®ç®±åº”é€šè¿‡éªŒè¯');
            assertEqual(isValidEmail('invalid-email'), false, '4.2 æ— æ•ˆé‚®ç®±åº”ä¸é€šè¿‡éªŒè¯');
            assertEqual(isValidEmail(''), false, '4.3 ç©ºé‚®ç®±åº”ä¸é€šè¿‡éªŒè¯');

            // å¯†ç é•¿åº¦éªŒè¯
            function isValidPassword(password) {
                return password.length >= 6;
            }

            assertEqual(isValidPassword('123456'), true, '4.4 6ä½å¯†ç åº”é€šè¿‡éªŒè¯');
            assertEqual(isValidPassword('12345'), false, '4.5 å°‘äº6ä½å¯†ç åº”ä¸é€šè¿‡éªŒè¯');
        }

        function testGroup5_ConfigConstants() {
            console.log('ğŸ§ª æµ‹è¯•ç»„5: é…ç½®å¸¸é‡');

            const CONFIG = {
                MAX_HISTORY_LOAD: 50,
                MAX_HISTORY_SEND: 20,
                MAX_HISTORY_MEMORY: 50,
                API_TIMEOUT: 30000,
                LANGUAGE_DETECT_TIMEOUT: 1500,
                TYPING_DELAY: 100,
            };

            assertEqual(CONFIG.MAX_HISTORY_LOAD, 50, '5.1 å†å²åŠ è½½æ•°é‡åº”ä¸º50');
            assertEqual(CONFIG.MAX_HISTORY_SEND, 20, '5.2 å‘é€AIçš„å†å²æ•°é‡åº”ä¸º20');
            assertEqual(CONFIG.API_TIMEOUT, 30000, '5.3 APIè¶…æ—¶åº”ä¸º30ç§’');
            assert(CONFIG.TYPING_DELAY < 200, '5.4 æ‰“å­—å»¶è¿Ÿåº”å°äº200ms');
        }

        function testGroup6_RetryLogic() {
            console.log('ğŸ§ª æµ‹è¯•ç»„6: é‡è¯•é€»è¾‘æ¨¡æ‹Ÿ');

            let attemptCount = 0;

            async function mockLoadQuota(shouldFail = false, retryCount = 0) {
                attemptCount++;

                if (shouldFail && retryCount < 2) {
                    // æ¨¡æ‹Ÿå¤±è´¥å¹¶é‡è¯•
                    const delay = (retryCount + 1) * 100;  // ç¼©çŸ­å»¶è¿Ÿç”¨äºæµ‹è¯•
                    await new Promise(r => setTimeout(r, delay));
                    return mockLoadQuota(shouldFail, retryCount + 1);
                }

                return shouldFail ? null : { quota: 5 };
            }

            // æµ‹è¯•é‡è¯•æ¬¡æ•°
            (async () => {
                attemptCount = 0;
                await mockLoadQuota(true);
                assertEqual(attemptCount, 3, '6.1 å¤±è´¥æ—¶åº”é‡è¯•2æ¬¡ï¼ˆå…±3æ¬¡å°è¯•ï¼‰');

                attemptCount = 0;
                const result = await mockLoadQuota(false);
                assertEqual(attemptCount, 1, '6.2 æˆåŠŸæ—¶åº”åªå°è¯•1æ¬¡');
                assertNotNull(result, '6.3 æˆåŠŸæ—¶åº”è¿”å›æ•°æ®');
            })();
        }

        function testGroup7_StringOperations() {
            console.log('ğŸ§ª æµ‹è¯•ç»„7: å­—ç¬¦ä¸²æ“ä½œ');

            // æµ‹è¯•é…é¢æ˜¾ç¤º
            function getQuotaDisplay(userQuota) {
                if (!userQuota) {
                    return '--';
                }
                return userQuota.quota;
            }

            assertEqual(getQuotaDisplay(null), '--', '7.1 nullåº”æ˜¾ç¤º"--"');
            assertEqual(getQuotaDisplay({ quota: 5 }), 5, '7.2 æœ‰é…é¢æ—¶åº”æ˜¾ç¤ºæ•°å­—');
            assertEqual(getQuotaDisplay({ quota: 0 }), 0, '7.3 é…é¢ä¸º0æ—¶åº”æ˜¾ç¤º0');

            // æµ‹è¯•å¤šè¯­è¨€
            function getErrorMessage(lang, error) {
                if (lang === 'zh') {
                    return 'ç½‘ç»œè¿æ¥ä¸­æ–­ï¼Œè¯·é‡è¯•';
                }
                return 'Network connection interrupted, please retry';
            }

            assert(getErrorMessage('zh').includes('é‡è¯•'), '7.4 ä¸­æ–‡é”™è¯¯æ¶ˆæ¯åº”åŒ…å«"é‡è¯•"');
            assert(getErrorMessage('en').includes('retry'), '7.5 è‹±æ–‡é”™è¯¯æ¶ˆæ¯åº”åŒ…å«"retry"');
        }

        function testGroup8_EdgeCases() {
            console.log('ğŸ§ª æµ‹è¯•ç»„8: è¾¹ç•Œæƒ…å†µ');

            // æµ‹è¯•ç©ºæ•°ç»„
            const emptyArray = [];
            assertEqual(emptyArray.slice(-20).length, 0, '8.1 ç©ºæ•°ç»„sliceåº”è¿”å›ç©ºæ•°ç»„');

            // æµ‹è¯•æ•°ç»„åˆ‡ç‰‡
            const largeArray = Array.from({ length: 100 }, (_, i) => i);
            assertEqual(largeArray.slice(-20).length, 20, '8.2 å¤§æ•°ç»„slice(-20)åº”è¿”å›20ä¸ªå…ƒç´ ');
            assertEqual(largeArray.slice(-20)[0], 80, '8.3 slice(-20)åº”ä»ç¬¬81ä¸ªå…ƒç´ å¼€å§‹');

            // æµ‹è¯•è¶…æ—¶æ§åˆ¶å™¨
            const controller = new AbortController();
            assertNotNull(controller.signal, '8.4 AbortControlleråº”æœ‰signalå±æ€§');

            controller.abort();
            assertEqual(controller.signal.aborted, true, '8.5 abortåsignal.abortedåº”ä¸ºtrue');
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            // é‡ç½®è®¡æ•°
            passCount = 0;
            failCount = 0;
            results = [];

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.querySelector('.run-button').disabled = true;

            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´è®©UIæ›´æ–°
            await new Promise(r => setTimeout(r, 100));

            // è¿è¡Œæ‰€æœ‰æµ‹è¯•ç»„
            try {
                testGroup1_LocalStorage();
                testGroup2_NameExtraction();
                testGroup3_JSONParse();
                testGroup4_InputValidation();
                testGroup5_ConfigConstants();
                await testGroup6_RetryLogic();
                testGroup7_StringOperations();
                testGroup8_EdgeCases();
            } catch (error) {
                console.error('æµ‹è¯•æ‰§è¡Œå‡ºé”™:', error);
                failCount++;
                results.push({
                    status: 'fail',
                    name: 'æµ‹è¯•æ‰§è¡Œå¼‚å¸¸',
                    error: error.message
                });
            }

            // ç­‰å¾…æ‰€æœ‰å¼‚æ­¥æµ‹è¯•å®Œæˆ
            await new Promise(r => setTimeout(r, 500));

            // æ˜¾ç¤ºç»“æœ
            displayResults();

            document.getElementById('loading').classList.remove('active');
            document.getElementById('results').classList.add('active');
            document.querySelector('.run-button').disabled = false;
        }

        function displayResults() {
            const totalCount = passCount + failCount;

            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('passCount').textContent = passCount;
            document.getElementById('failCount').textContent = failCount;
            document.getElementById('totalCount').textContent = totalCount;

            // æŒ‰æµ‹è¯•ç»„åˆ†ç»„æ˜¾ç¤º
            const groups = {
                '1. localStorageå®‰å…¨åŒ…è£…': results.filter(r => r.name.startsWith('1.')),
                '2. ç”¨æˆ·å§“åæå–': results.filter(r => r.name.startsWith('2.')),
                '3. JSONå®¹é”™å¤„ç†': results.filter(r => r.name.startsWith('3.')),
                '4. è¾“å…¥éªŒè¯': results.filter(r => r.name.startsWith('4.')),
                '5. é…ç½®å¸¸é‡': results.filter(r => r.name.startsWith('5.')),
                '6. é‡è¯•é€»è¾‘': results.filter(r => r.name.startsWith('6.')),
                '7. å­—ç¬¦ä¸²æ“ä½œ': results.filter(r => r.name.startsWith('7.')),
                '8. è¾¹ç•Œæƒ…å†µ': results.filter(r => r.name.startsWith('8.')),
            };

            let html = '';

            for (const [groupName, groupResults] of Object.entries(groups)) {
                if (groupResults.length === 0) continue;

                html += `
                    <div class="test-group">
                        <div class="test-group-title">${groupName}</div>
                `;

                groupResults.forEach(result => {
                    html += `
                        <div class="test-case ${result.status}">
                            <div class="test-name">
                                <span class="test-status ${result.status}">${result.status === 'pass' ? 'âœ“ PASS' : 'âœ— FAIL'}</span>
                                ${result.name}
                            </div>
                            <div class="test-details">${result.details || ''}</div>
                            ${result.error ? `<div class="test-error">é”™è¯¯: ${result.error}</div>` : ''}
                        </div>
                    `;
                });

                html += '</div>';
            }

            document.getElementById('results').innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæç¤º
        window.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>
